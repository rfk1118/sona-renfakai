import{_ as l,V as r,W as i,X as s,a0 as n,Y as a,Z as o,$ as t,F as p}from"./framework-fd210779.js";const u={},d=s("h1",{id:"多线程编程",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#多线程编程","aria-hidden":"true"},"#"),n(" 多线程编程")],-1),k=s("h2",{id:"aqs",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#aqs","aria-hidden":"true"},"#"),n(" aqs")],-1),m={href:"http://gee.cs.oswego.edu/dl/papers/aqs.pdf",target:"_blank",rel:"noopener noreferrer"},v=s("code",null,"synchronized、Thread.suspend、等待集、Object.wait、Object.signal",-1),b=s("code",null,"juc",-1),h=s("code",null,"java",-1),_=s("code",null,"jvm",-1),y=t("<ul><li><code>cas</code>修改状态代替<code>synchronized</code>的获取</li><li><code>LockSupport</code>代替阻塞</li><li><code>clh</code>锁代替等待集，自旋代替上下文切换</li><li>条件队列颗粒度优化<code>Object.wait、signal</code></li></ul>",1),f={id:"synchronize-state",tabindex:"-1"},j=s("a",{class:"header-anchor",href:"#synchronize-state","aria-hidden":"true"},"#",-1),g=t(`<p><code>synchronize state = synchronized</code>，<code>monitorenter、monitorexit</code>使用状态协议字段替换，例如以下代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Sy</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">testSynchronized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Sy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test sy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">testLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test sy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码编译和查看字节码，从字节码可以看出<code>synchronized</code>使用<code>jvm</code>内置锁，也就是<code>monitorenter、monitorexit</code>，而<code>juc</code>中的<code>lock</code>并没有使用内置锁</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>javac <span class="token class-name">Sy</span><span class="token punctuation">.</span>java
javap <span class="token operator">-</span>v <span class="token class-name">Sy</span>

<span class="token keyword">void</span> <span class="token function">testSynchronized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span>
    flags<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0x0000</span><span class="token punctuation">)</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">2</span>                  <span class="token comment">// class com/sona/juc/Sy</span>
         <span class="token number">2</span><span class="token operator">:</span> dup
         <span class="token number">3</span><span class="token operator">:</span> astore_1
         <span class="token comment">// 内置锁进入</span>
         <span class="token number">4</span><span class="token operator">:</span> monitorenter
         <span class="token number">5</span><span class="token operator">:</span> getstatic     #<span class="token number">3</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
         <span class="token number">8</span><span class="token operator">:</span> ldc           #<span class="token number">4</span>                  <span class="token comment">// String test sy</span>
        <span class="token number">10</span><span class="token operator">:</span> invokevirtual #<span class="token number">5</span>                  <span class="token comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
        <span class="token number">13</span><span class="token operator">:</span> aload_1
        <span class="token comment">// 内置锁退出</span>
        <span class="token number">14</span><span class="token operator">:</span> monitorexit
        <span class="token number">15</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">23</span>
        <span class="token number">18</span><span class="token operator">:</span> astore_2
        <span class="token number">19</span><span class="token operator">:</span> aload_1
        <span class="token comment">// 内置锁退出</span>
        <span class="token number">20</span><span class="token operator">:</span> monitorexit
        <span class="token number">21</span><span class="token operator">:</span> aload_2
        <span class="token number">22</span><span class="token operator">:</span> athrow
        <span class="token number">23</span><span class="token operator">:</span> <span class="token keyword">return</span>
      <span class="token class-name">Exception</span> table<span class="token operator">:</span>
         from    <span class="token keyword">to</span>  <span class="token namespace">target</span> type
             <span class="token number">5</span>    <span class="token number">15</span>    <span class="token number">18</span>   any
            <span class="token number">18</span>    <span class="token number">21</span>    <span class="token number">18</span>   any
      <span class="token class-name">LineNumberTable</span><span class="token operator">:</span>
        line <span class="token number">10</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">11</span><span class="token operator">:</span> <span class="token number">5</span>
        line <span class="token number">12</span><span class="token operator">:</span> <span class="token number">13</span>
        line <span class="token number">13</span><span class="token operator">:</span> <span class="token number">23</span>
      <span class="token class-name">StackMapTable</span><span class="token operator">:</span> number_of_entries <span class="token operator">=</span> <span class="token number">2</span>
        frame_type <span class="token operator">=</span> <span class="token number">255</span> <span class="token comment">/* full_frame */</span>
          offset_delta <span class="token operator">=</span> <span class="token number">18</span>
          locals <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token keyword">class</span> com<span class="token operator">/</span>sona<span class="token operator">/</span>juc<span class="token operator">/</span><span class="token class-name">Sy</span><span class="token punctuation">,</span> <span class="token keyword">class</span> java<span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Object</span> <span class="token punctuation">]</span>
          stack <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token keyword">class</span> java<span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Throwable</span> <span class="token punctuation">]</span>
        frame_type <span class="token operator">=</span> <span class="token number">250</span> <span class="token comment">/* chop */</span>
          offset_delta <span class="token operator">=</span> <span class="token number">4</span>

  <span class="token keyword">void</span> <span class="token function">testLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span>
    flags<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0x0000</span><span class="token punctuation">)</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> getstatic     #<span class="token number">6</span>                  <span class="token comment">// Field lock:Ljava/util/concurrent/locks/Lock;</span>
         <span class="token number">3</span><span class="token operator">:</span> invokeinterface #<span class="token number">7</span><span class="token punctuation">,</span>  <span class="token number">1</span>            <span class="token comment">// InterfaceMethod java/util/concurrent/locks/Lock.lock:()V</span>
         <span class="token number">8</span><span class="token operator">:</span> getstatic     #<span class="token number">3</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="token number">11</span><span class="token operator">:</span> ldc           #<span class="token number">4</span>                  <span class="token comment">// String test sy</span>
        <span class="token number">13</span><span class="token operator">:</span> invokevirtual #<span class="token number">5</span>                  <span class="token comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
        <span class="token number">16</span><span class="token operator">:</span> getstatic     #<span class="token number">6</span>                  <span class="token comment">// Field lock:Ljava/util/concurrent/locks/Lock;</span>
        <span class="token number">19</span><span class="token operator">:</span> invokeinterface #<span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">1</span>            <span class="token comment">// InterfaceMethod java/util/concurrent/locks/Lock.unlock:()V</span>
        <span class="token number">24</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">38</span>
        <span class="token number">27</span><span class="token operator">:</span> astore_1
        <span class="token number">28</span><span class="token operator">:</span> getstatic     #<span class="token number">6</span>                  <span class="token comment">// Field lock:Ljava/util/concurrent/locks/Lock;</span>
        <span class="token number">31</span><span class="token operator">:</span> invokeinterface #<span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">1</span>            <span class="token comment">// InterfaceMethod java/util/concurrent/locks/Lock.unlock:()V</span>
        <span class="token number">36</span><span class="token operator">:</span> aload_1
        <span class="token number">37</span><span class="token operator">:</span> athrow
        <span class="token number">38</span><span class="token operator">:</span> <span class="token keyword">return</span>
      <span class="token class-name">Exception</span> table<span class="token operator">:</span>
         from    <span class="token keyword">to</span>  <span class="token namespace">target</span> type
             <span class="token number">8</span>    <span class="token number">16</span>    <span class="token number">27</span>   any
      <span class="token class-name">LineNumberTable</span><span class="token operator">:</span>
        line <span class="token number">16</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">18</span><span class="token operator">:</span> <span class="token number">8</span>
        line <span class="token number">20</span><span class="token operator">:</span> <span class="token number">16</span>
        line <span class="token number">21</span><span class="token operator">:</span> <span class="token number">24</span>
        line <span class="token number">20</span><span class="token operator">:</span> <span class="token number">27</span>
        line <span class="token number">21</span><span class="token operator">:</span> <span class="token number">36</span>
        line <span class="token number">22</span><span class="token operator">:</span> <span class="token number">38</span>
      <span class="token class-name">StackMapTable</span><span class="token operator">:</span> number_of_entries <span class="token operator">=</span> <span class="token number">2</span>
        frame_type <span class="token operator">=</span> <span class="token number">91</span> <span class="token comment">/* same_locals_1_stack_item */</span>
          stack <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token keyword">class</span> java<span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Throwable</span> <span class="token punctuation">]</span>
        frame_type <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment">/* same */</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),w=s("code",null,"lock",-1),x=s("code",null,"cas",-1),S=s("code",null,"aqs",-1),L=s("code",null,"state",-1),q=s("h3",{id:"block",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#block","aria-hidden":"true"},"#"),n(" Block")],-1),z=s("code",null,"Thread.suspend、Thread.resume",-1),T=s("code",null,"LockSupport.park、LockSupport.unpark",-1),V=s("h3",{id:"clh锁",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#clh锁","aria-hidden":"true"},"#"),n(" clh锁")],-1),E=s("code",null,"clh锁",-1),P=s("code",null,"AbstractQueuedSynchronizer.acquireQueued",-1),M=s("h3",{id:"条件队列",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#条件队列","aria-hidden":"true"},"#"),n(" 条件队列")],-1),F=s("code",null,"Object.wait、signal",-1),B=t('<h2 id="应用" tabindex="-1"><a class="header-anchor" href="#应用" aria-hidden="true">#</a> 应用</h2><p>如果把<code>aqs</code>当作基石，在其基础上构建的应用主要分为两种，一是基于数据的，另外一个是基于任务的</p><ul><li>基于数据：<code>BlockingDeque、BlockingQueue</code>等</li><li>基于任务：<code>ThreadPoolExecutor、ScheduledThreadPoolExecutor、ForkJoinPool</code>等</li></ul><h3 id="数据类型" tabindex="-1"><a class="header-anchor" href="#数据类型" aria-hidden="true">#</a> 数据类型</h3>',4),N=s("h3",{id:"基于任务",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#基于任务","aria-hidden":"true"},"#"),n(" 基于任务")],-1),I=t('<h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p><code>aqs</code>构建了底层基石，在此基础上构建了数据类型<code>Queue</code>和任务类型应用<code>PoolExecutor</code>，如果把<code>aqs</code>当作服务端，那么<code>Queue</code>和<code>PoolExecutor</code>相对而言属于客户端。</p>',2);function O(Q,C){const c=p("ExternalLinkIcon"),e=p("RouterLink");return r(),i("div",null,[d,k,s("p",null,[n("aqs设计理念推荐看"),s("a",m,[n("文档"),a(c)]),n("，论文中很容易看出设计围绕四个方向("),v,n("，设计实现细节，推荐看源码。 整体来讲"),b,n("是把"),h,n("内置锁从底层"),_,n("层面拿到代码层面进行优化。")]),y,s("h3",f,[j,n(),a(e,{to:"/languages/java/thread/java/juc/aqs.html"},{default:o(()=>[n("synchronize state")]),_:1})]),g,s("p",null,[w,n("使用"),x,n("方式更新"),S,n("内的一个状态"),L,n("为契约代表锁的获取，释放，详情可以看"),a(e,{to:"/languages/java/thread/java/juc/aqs.html"},{default:o(()=>[n("aqs")]),_:1})]),q,s("p",null,[n("阻塞是代替"),z,n("，使用是"),T,n("，详情可以看"),a(e,{to:"/languages/java/thread/java/juc/blocking.html"},{default:o(()=>[n("LockSupport")]),_:1})]),V,s("p",null,[E,n("代替内置等待集，并且每个节点不通信，减少通信带来的复杂程度，使用自旋减少上下文切换。详情可以看"),a(e,{to:"/languages/java/thread/java/juc/clh.html"},{default:o(()=>[n("clh")]),_:1}),n("，自旋代码可以查看"),P,n("。")]),M,s("p",null,[n("条件队列颗粒度优化"),F,n("，详情见"),a(e,{to:"/languages/java/thread/java/juc/condition.html"},{default:o(()=>[n("condition")]),_:1})]),B,s("p",null,[n("关于数据类型应用，可以参考"),a(e,{to:"/languages/java/thread/java/juc/condition.html"},{default:o(()=>[n("condition")]),_:1})]),N,s("p",null,[n("关于数据类型应用，可以参考"),a(e,{to:"/languages/java/thread/java/juc/"},{default:o(()=>[n("PoolExecutor")]),_:1})]),I])}const A=l(u,[["render",O],["__file","read-me.html.vue"]]);export{A as default};
