import{_ as p,V as o,W as c,Y as n,a1 as s,Z as t,a0 as e,F as i}from"./framework-e54e0297.js";const l="/assets/flashloan-3ad1e3b3.png",u={},r=n("h1",{id:"flashloan",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#flashloan","aria-hidden":"true"},"#"),s(" FlashLoan")],-1),d=n("p",null,"闪电贷是在不占用自有资金情况下最大限度获得利润的方式，常用场景为套利，本页面代码使用的是AAVE v2版本。",-1),k={class:"hint-container tip"},v=n("p",{class:"hint-container-title"},"代码",-1),m={href:"https://github.com/jspruance/aave-flash-loan-tutorial",target:"_blank",rel:"noopener noreferrer"},b=n("h2",{id:"v2版本",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#v2版本","aria-hidden":"true"},"#"),s(" v2版本")],-1),f={href:"https://github.com/jspruance/aave-flash-loan-tutorial/blob/main/aave-flash-loan-v2/contracts/FlashLoan.sol",target:"_blank",rel:"noopener noreferrer"},h=n("code",null,"own",-1),w=n("code",null,"token",-1),g=e(`<div class="language-solidity line-numbers-mode" data-ext="solidity"><pre class="language-solidity"><code>
<span class="token comment">// SPDX-License-Identifier: UNLICENSED</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token number">0.6</span><span class="token number">.12</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>FlashLoanReceiverBase<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@aave/protocol-v2/contracts/flashloan/base/FlashLoanReceiverBase.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ILendingPool<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@aave/protocol-v2/contracts/interfaces/ILendingPool.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ILendingPoolAddressesProvider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@aave/protocol-v2/contracts/interfaces/ILendingPoolAddressesProvider.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>IERC20<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@aave/protocol-v2/contracts/dependencies/openzeppelin/contracts/IERC20.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">FlashLoan</span> <span class="token keyword">is</span> FlashLoanReceiverBase <span class="token punctuation">{</span>
    <span class="token comment">// 保存部署者</span>
    <span class="token builtin">address</span> <span class="token keyword">private</span> immutable owner<span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> _addressProvider
    <span class="token punctuation">)</span>
        <span class="token keyword">public</span>
        <span class="token function">FlashLoanReceiverBase</span><span class="token punctuation">(</span><span class="token function">ILendingPoolAddressesProvider</span><span class="token punctuation">(</span>_addressProvider<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        owner <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeOperation</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> assets<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> amounts<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> premiums<span class="token punctuation">,</span>
        <span class="token builtin">address</span> <span class="token comment">/**initiator**/</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> <span class="token comment">/**params**/</span>
    <span class="token punctuation">)</span> <span class="token keyword">external</span> override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 迭代代币地址</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> assets<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 计算出每个代币地址的借贷和利息</span>
            <span class="token builtin">uint256</span> amountOwing <span class="token operator">=</span> amounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>premiums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 授权给池子金额，这样池子能够拿代币</span>
            <span class="token function">IERC20</span><span class="token punctuation">(</span>assets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>LENDING_POOL<span class="token punctuation">)</span><span class="token punctuation">,</span> amountOwing<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">requestFlashLoan</span><span class="token punctuation">(</span><span class="token builtin">address</span> _token<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token builtin">address</span> receiverAddress <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 代币地址</span>
        <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> assets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        assets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> _token<span class="token punctuation">;</span>
        <span class="token comment">// 借贷数量</span>
        <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> amounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        amounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> _amount<span class="token punctuation">;</span>
        <span class="token comment">// 0 = no debt, 1 = stable, 2 = variable</span>
        <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> modes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 接收代币地址</span>
        <span class="token builtin">address</span> onBehalfOf <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LENDING_POOL<span class="token punctuation">.</span><span class="token function">flashLoan</span><span class="token punctuation">(</span>
            receiverAddress<span class="token punctuation">,</span>
            assets<span class="token punctuation">,</span>
            amounts<span class="token punctuation">,</span>
            modes<span class="token punctuation">,</span>
            onBehalfOf<span class="token punctuation">,</span>
            <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token number">0</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取</span>
    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token builtin">address</span> _tokenAddress<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_tokenAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 提款</span>
    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">address</span> _tokenAddress<span class="token punctuation">)</span> <span class="token keyword">external</span> onlyOwner <span class="token punctuation">{</span>
        <span class="token function">IERC20</span><span class="token punctuation">(</span>_tokenAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>
            <span class="token function">IERC20</span><span class="token punctuation">(</span>_tokenAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 权限</span>
    <span class="token keyword">modifier</span> <span class="token function">onlyOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">,</span>
            <span class="token string">&quot;Only the contract owner can call this function&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 接收eth</span>
    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="对其部署" tabindex="-1"><a class="header-anchor" href="#对其部署" aria-hidden="true">#</a> 对其部署</h3><p>hardhat 配置如下：</p><div class="language-config line-numbers-mode" data-ext="config"><pre class="language-config"><code>const config: HardhatUserConfig = {
  solidity: {
    version: &quot;0.6.12&quot;,
  },
  networks: {
    goerli: {
      url: &quot;https://ethereum-goerli.publicnode.com&quot;,
      accounts: [
        &quot;私钥匙请自行配置&quot;,
      ],
    },
  },
};
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),y={href:"https://docs.aave.com/developers/deployed-contracts/v3-testnet-addresses",target:"_blank",rel:"noopener noreferrer"},q=e(`<div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> hre <span class="token keyword">from</span> <span class="token string">&quot;hardhat&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// v3地址：0xC911B590248d127aD18546B186cC6B324e99F02c</span>
<span class="token comment">// v2地址：0x5E52dEc931FFb32f609681B8438A51c675cc232d</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;deploying...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> FlashLoan <span class="token operator">=</span> <span class="token keyword">await</span> hre<span class="token punctuation">.</span>ethers<span class="token punctuation">.</span><span class="token function">getContractFactory</span><span class="token punctuation">(</span><span class="token string">&quot;FlashLoan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> flashLoan <span class="token operator">=</span> <span class="token keyword">await</span> FlashLoan<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>
    <span class="token string">&quot;0xC911B590248d127aD18546B186cC6B324e99F02c&quot;</span>
    <span class="token comment">// 后面加了gas限制还是错误，然后意识到了这里使用的协议版本不对</span>
    <span class="token comment">// {</span>
    <span class="token comment">//   gasPrice: ethers.utils.parseUnits(&quot;100&quot;, &quot;gwei&quot;),</span>
    <span class="token comment">//   gasLimit: 2100000,</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> flashLoan<span class="token punctuation">.</span><span class="token function">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Flash loan contract deployed: &quot;</span><span class="token punctuation">,</span> flashLoan<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span>exitCode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行<code>npx hardhat run ./scripts/deploy.ts --network goerli</code>，运行后报错:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code> cannot estimate gas<span class="token punctuation">;</span> transaction may fail or may <span class="token keyword">require</span> manual gas limit <span class="token punctuation">[</span> See<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>links<span class="token punctuation">.</span>ethers<span class="token punctuation">.</span>org<span class="token operator">/</span>v5<span class="token operator">-</span>errors<span class="token operator">-</span><span class="token constant">UNPREDICTABLE_GAS_LIMIT</span> <span class="token punctuation">]</span>
 reason<span class="token operator">:</span> <span class="token string">&#39;execution reverted&#39;</span><span class="token punctuation">,</span>
 code<span class="token operator">:</span> <span class="token string">&#39;UNPREDICTABLE_GAS_LIMIT&#39;</span><span class="token punctuation">,</span>
 method<span class="token operator">:</span> <span class="token string">&#39;estimateGas&#39;</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在代码中继续加入<code>gasPrice</code>后依然报错，错误如下：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>  reason<span class="token operator">:</span> <span class="token string">&#39;execution reverted&#39;</span><span class="token punctuation">,</span>
  code<span class="token operator">:</span> <span class="token string">&#39;UNPREDICTABLE_GAS_LIMIT&#39;</span><span class="token punctuation">,</span>
  method<span class="token operator">:</span> <span class="token string">&#39;estimateGas&#39;</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>排查发现是协议使用错误导致其构造函数出错，修改地址为v2版本则成功。</p><h2 id="获取代码" tabindex="-1"><a class="header-anchor" href="#获取代码" aria-hidden="true">#</a> 获取代码</h2>`,7),_={href:"https://celo.academy/t/how-to-build-and-deploy-flashloan-contracts-on-celo-with-aave/25",target:"_blank",rel:"noopener noreferrer"},L={href:"https://goerli.etherscan.io/address/0x9FD21bE27A2B059a288229361E2fA632D8D2d074",target:"_blank",rel:"noopener noreferrer"},A=e(`<div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> hre <span class="token keyword">from</span> <span class="token string">&quot;hardhat&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ethers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;hardhat&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// v3地址：0xC911B590248d127aD18546B186cC6B324e99F02c</span>
<span class="token comment">// v2地址：0x5E52dEc931FFb32f609681B8438A51c675cc232d</span>

<span class="token keyword">const</span> usdcAbi <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;constructor(string name, string symbol, uint8 decimals)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;event Approval(address indexed owner, address indexed spender, uint256 value)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;event Transfer(address indexed from, address indexed to, uint256 value)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function allowance(address owner, address spender) view returns (uint256)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function approve(address spender, uint256 amount) returns (bool)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function balanceOf(address account) view returns (uint256)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function decimals() view returns (uint8)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function decreaseAllowance(address spender, uint256 subtractedValue) returns (bool)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function increaseAllowance(address spender, uint256 addedValue) returns (bool)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function mint(uint256 value) returns (bool)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function name() view returns (string)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function symbol() view returns (string)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function totalSupply() view returns (uint256)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function transfer(address recipient, uint256 amount) returns (bool)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function transferFrom(address sender, address recipient, uint256 amount) returns (bool)&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> abi <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;constructor(address _addressProvider)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function ADDRESSES_PROVIDER() view returns (address)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function LENDING_POOL() view returns (address)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function executeOperation(address[] assets, uint256[] amounts, uint256[] premiums, address, bytes) returns (bool)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function getBalance(address _tokenAddress) view returns (uint256)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function requestFlashLoan(address _token, uint256 _amount)&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;function withdraw(address _tokenAddress)&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> usdcAddress <span class="token operator">=</span> <span class="token string">&quot;0x9FD21bE27A2B059a288229361E2fA632D8D2d074&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> v2FlashAddress <span class="token operator">=</span> <span class="token string">&quot;0x5E52dEc931FFb32f609681B8438A51c675cc232d&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mintMoney <span class="token operator">=</span> <span class="token number">1000000000</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取账户</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>owner<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> ethers<span class="token punctuation">.</span><span class="token function">getSigners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取合约</span>
  <span class="token keyword">const</span> FlashLoan <span class="token operator">=</span> <span class="token keyword">await</span> hre<span class="token punctuation">.</span>ethers<span class="token punctuation">.</span><span class="token function">getContractFactory</span><span class="token punctuation">(</span><span class="token string">&quot;FlashLoan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 部署合约</span>
  <span class="token keyword">const</span> flashLoan <span class="token operator">=</span> <span class="token keyword">await</span> FlashLoan<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>v2FlashAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> flashLoan<span class="token punctuation">.</span><span class="token function">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;部署FlashLoanAddress&quot;</span> <span class="token operator">+</span> flashLoan<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> FlashLoanAddress <span class="token operator">=</span> flashLoan<span class="token punctuation">.</span>address<span class="token punctuation">;</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始claim&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 领取usdc claim</span>
  <span class="token keyword">const</span> usdcContract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span><span class="token function">Contract</span><span class="token punctuation">(</span>usdcAddress<span class="token punctuation">,</span> usdcAbi<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> claim <span class="token operator">=</span> <span class="token punctuation">{</span>
    from<span class="token operator">:</span> owner<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    to<span class="token operator">:</span> usdcAddress<span class="token punctuation">,</span>
    data<span class="token operator">:</span> usdcContract<span class="token punctuation">.</span>interface<span class="token punctuation">.</span><span class="token function">encodeFunctionData</span><span class="token punctuation">(</span><span class="token string">&quot;mint&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>mintMoney<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> transactionResponse <span class="token operator">=</span> <span class="token keyword">await</span> owner<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>claim<span class="token punctuation">)</span><span class="token punctuation">;</span>
  transactionResponse<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;claim结果&quot;</span> <span class="token operator">+</span> transactionResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> balanceOf <span class="token operator">=</span> <span class="token keyword">await</span> usdcContract<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>owner<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;转账给flash loan金额&quot;</span> <span class="token operator">+</span> balanceOf<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> transferPara <span class="token operator">=</span> <span class="token punctuation">{</span>
    from<span class="token operator">:</span> owner<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    to<span class="token operator">:</span> usdcAddress<span class="token punctuation">,</span>
    data<span class="token operator">:</span> usdcContract<span class="token punctuation">.</span>interface<span class="token punctuation">.</span><span class="token function">encodeFunctionData</span><span class="token punctuation">(</span><span class="token string">&quot;transfer&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      FlashLoanAddress<span class="token punctuation">,</span>
      balanceOf<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> transferResult <span class="token operator">=</span> <span class="token keyword">await</span> owner<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>transferPara<span class="token punctuation">)</span><span class="token punctuation">;</span>
  transferResult<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;转账成功，tx&quot;</span> <span class="token operator">+</span> transferResult<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 拿到flash合约</span>
  <span class="token keyword">const</span> flashLoanContract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span><span class="token function">Contract</span><span class="token punctuation">(</span>flashLoan<span class="token punctuation">.</span>address<span class="token punctuation">,</span> abi<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建参数</span>
  <span class="token keyword">const</span> flashLoanParams <span class="token operator">=</span> <span class="token punctuation">{</span>
    from<span class="token operator">:</span> owner<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    to<span class="token operator">:</span> flashLoan<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    data<span class="token operator">:</span> flashLoanContract<span class="token punctuation">.</span>interface<span class="token punctuation">.</span><span class="token function">encodeFunctionData</span><span class="token punctuation">(</span><span class="token string">&quot;requestFlashLoan&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      usdcAddress<span class="token punctuation">,</span>
      mintMoney<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 进行借贷</span>
  <span class="token keyword">const</span> flashLoanResult <span class="token operator">=</span> <span class="token keyword">await</span> owner<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>flashLoanParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Transaction hash: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>flashLoanResult<span class="token punctuation">.</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span>exitCode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果如下:</p><p><img src="`+l+'" alt="An image"></p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2>',4),x={href:"https://docs.aave.com/developers/core-contracts/pool#flashloan",target:"_blank",rel:"noopener noreferrer"},F={href:"https://aave.com/",target:"_blank",rel:"noopener noreferrer"},E={href:"https://docs.aave.com/developers/deployed-contracts/v3-testnet-addresses",target:"_blank",rel:"noopener noreferrer"},B={href:"https://www.youtube.com/watch?v=PtMs8FZJhkU",target:"_blank",rel:"noopener noreferrer"},C={href:"https://www.youtube.com/@BlockExplorerMedia",target:"_blank",rel:"noopener noreferrer"};function I(D,P){const a=i("ExternalLinkIcon");return o(),c("div",null,[r,d,n("div",k,[v,n("p",null,[n("a",m,[s("代码地址"),t(a)])])]),b,n("p",null,[n("a",f,[s("参考代码地址"),t(a)]),s("，测试阶段发现没有命名"),h,s("变量和在提现时无"),w,s("变量，对其修正后代码如下：")]),g,n("p",null,[s("开始进行部署，直接在"),n("a",y,[s("TestAddress"),t(a)]),s("获取到了地址，部署代码如下：")]),q,n("p",null,[n("a",_,[s("How to Build and Deploy Flashloan Contracts on Celo with Aave"),t(a)]),s(" 参考这个文章。")]),n("p",null,[s("在"),n("a",L,[s("0x9FD21bE27A2B059a288229361E2fA632D8D2d074"),t(a)]),s("获取usdc。")]),A,n("ul",null,[n("li",null,[n("a",x,[s("doc Address"),t(a)])]),n("li",null,[n("a",F,[s("Markets"),t(a)])]),n("li",null,[n("a",E,[s("TestAddress"),t(a)])]),n("li",null,[n("a",B,[s("jspruance"),t(a)])]),n("li",null,[n("a",C,[s("BlockExplorerMedia"),t(a)])])])])}const O=p(u,[["render",I],["__file","flashloan.html.vue"]]);export{O as default};
