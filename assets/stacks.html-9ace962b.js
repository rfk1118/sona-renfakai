import{_ as t,V as o,W as p,X as a,a0 as s,Y as e,$ as c,F as i}from"./framework-5793c714.js";const l="/assets/stack-56519ef2.jpg",r="/assets/vframe-all-06d6c516.jpg",u={},d=c('<h1 id="stacks" tabindex="-1"><a class="header-anchor" href="#stacks" aria-hidden="true">#</a> Stacks</h1><h2 id="java-virtual-machine-stacks" tabindex="-1"><a class="header-anchor" href="#java-virtual-machine-stacks" aria-hidden="true">#</a> Java-Virtual-Machine-Stacks</h2><div class="hint-container tip"><p class="hint-container-title">官方文档</p><p>Each Java Virtual Machine thread has a private Java Virtual Machine stack, created at the same time as the thread. A Java Virtual Machine stack stores frames (§2.6). A Java Virtual Machine stack is analogous to the stack of a conventional language such as C: it holds local variables and partial results, and plays a part in method invocation and return. Because the Java Virtual Machine stack is never manipulated directly except to push and pop frames, frames may be heap allocated. The memory for a Java Virtual Machine stack does not need to be contiguous.</p><p>This specification permits Java Virtual Machine stacks either to be of a fixed size or to dynamically expand and contract as required by the computation. If the Java Virtual Machine stacks are of a fixed size, the size of each Java Virtual Machine stack may be chosen independently when that stack is created. A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of Java Virtual Machine stacks, as well as, in the case of dynamically expanding or contracting Java Virtual Machine stacks, control over the maximum and minimum sizes. The following exceptional conditions are associated with Java Virtual Machine stacks: • If the computation in a thread requires a larger Java Virtual Machine stack than is permitted, the Java Virtual Machine throws a StackOverflowError. • If Java Virtual Machine stacks can be dynamically expanded, and expansion is attempted but insufficient memory can be made available to effect the expansion, or if insufficient memory can be made available to create the initial Java Virtual Machine stack for a new thread, the Java Virtual Machine throws an OutOfMemoryError.</p></div><p>每个Java虚拟机线程都有一个与线程同时创建的专用Java虚拟机堆栈。Java虚拟机堆栈存储帧（§2.6）。Java虚拟机堆栈类似于C等传统语言的堆栈：它包含局部变量和部分结果，并在方法调用和返回中发挥作用。由于Java虚拟机堆栈除了推送和弹出帧外从未直接操作，因此帧可能会被分配堆。Java虚拟机堆栈的内存不需要连续。 本规范允许Java虚拟机堆栈具有固定大小，或根据计算要求动态扩展和收缩。如果Java虚拟机堆栈的大小固定，则可以在创建该堆栈时独立选择每个Java虚拟机堆栈的大小。</p><p>Java虚拟机实现可以为程序员或用户提供对Java虚拟机堆栈初始大小的控制，以及在动态扩展或收缩Java虚拟机堆栈的情况下，对最大和最小大小的控制。</p><p>以下特殊条件与Java虚拟机堆栈相关联：</p><ul><li>如果线程中的计算需要比允许更大的Java虚拟机堆栈，Java虚拟机将抛出堆栈溢出错误。</li><li>如果Java虚拟机堆栈可以动态扩展，并尝试扩展，但可用于实现扩展的内存不足，或者如果可用于为新线程创建初始Java虚拟机堆栈的内存不足，Java虚拟机将抛出内存错误。</li></ul><h3 id="堆栈溢出" tabindex="-1"><a class="header-anchor" href="#堆栈溢出" aria-hidden="true">#</a> 堆栈溢出</h3><p>虚拟机栈使用<code>-Xss</code>进行设定，从图中可以看出，虚拟机栈包含<code>Frames</code>。如果想要<code>StackOverflowError</code>，可以从下面那种方式出发:</p><ol><li>无跳出递归产生<code>Frame</code></li><li>局部变量表无限大</li></ol><p><img src="'+l+`" alt="An image"></p><h3 id="oom" tabindex="-1"><a class="header-anchor" href="#oom" aria-hidden="true">#</a> oom</h3><p>由于Java不允许对虚拟机栈进行动态扩容，所以想<code>oom</code>，在<code>-Xss</code>大小指定的情况下，创建线程过多，也会导致内存不足。</p><h3 id="vframe" tabindex="-1"><a class="header-anchor" href="#vframe" aria-hidden="true">#</a> vframe</h3><p>vframes 是表示源级激活的虚拟堆栈帧。与优化代码一起存储的调试使我们能够将帧展开为<code>vframe</code>堆栈。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// vframes are virtual stack frames representing source level activations.</span>
<span class="token comment">// A single frame may hold several source level activations in the case of</span>
<span class="token comment">// optimized code. The debugging stored with the optimized code enables</span>
<span class="token comment">// us to unfold a frame as a stack of vframes.</span>
<span class="token comment">// A cVFrame represents an activation of a non-java method.</span>

<span class="token comment">// The vframe inheritance hierarchy:</span>
<span class="token comment">// - vframe</span>
<span class="token comment">//   - javaVFrame</span>
<span class="token comment">//     - interpretedVFrame</span>
<span class="token comment">//     - compiledVFrame     ; (used for both compiled Java methods and native stubs)</span>
<span class="token comment">//   - externalVFrame</span>
<span class="token comment">//     - entryVFrame        ; special frame created when calling Java from C</span>

<span class="token comment">// - BasicLock</span>
<span class="token keyword">class</span> vframe<span class="token operator">:</span> <span class="token keyword">public</span> <span class="token class-name">ResourceObj</span> <span class="token punctuation">{</span>
 <span class="token keyword">protected</span><span class="token operator">:</span>
  <span class="token comment">// 真实的frame</span>
  frame        _fr<span class="token punctuation">;</span>      <span class="token comment">// Raw frame behind the virtual frame.</span>
  <span class="token class-name">RegisterMap</span>  _reg_map<span class="token punctuation">;</span> <span class="token comment">// Register map for the raw frame (used to handle callee-saved registers).</span>
  <span class="token class-name">JavaThread</span><span class="token operator">*</span>  _thread<span class="token punctuation">;</span>  <span class="token comment">// The thread owning the raw frame.</span>

  <span class="token function">vframe</span><span class="token punctuation">(</span><span class="token keyword">const</span> frame<span class="token operator">*</span> fr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">RegisterMap</span><span class="token operator">*</span> reg_map<span class="token punctuation">,</span> <span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vframe</span><span class="token punctuation">(</span><span class="token keyword">const</span> frame<span class="token operator">*</span> fr<span class="token punctuation">,</span> <span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Factory methods for creating vframes</span>
  <span class="token keyword">static</span> vframe<span class="token operator">*</span> <span class="token function">new_vframe</span><span class="token punctuation">(</span><span class="token keyword">const</span> frame<span class="token operator">*</span> f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">RegisterMap</span> <span class="token operator">*</span>reg_map<span class="token punctuation">,</span> <span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> vframe<span class="token operator">*</span> <span class="token function">new_vframe</span><span class="token punctuation">(</span><span class="token class-name">StackFrameStream</span><span class="token operator">&amp;</span> fst<span class="token punctuation">,</span> <span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Accessors</span>
  frame              <span class="token function">fr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _fr<span class="token punctuation">;</span>       <span class="token punctuation">}</span>
  <span class="token class-name">CodeBlob</span><span class="token operator">*</span>          <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _fr<span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>
  <span class="token class-name">CompiledMethod</span><span class="token operator">*</span>   <span class="token function">nm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_compiled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;usage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">CompiledMethod</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ???? Does this need to be a copy?</span>
  frame<span class="token operator">*</span>             <span class="token function">frame_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>_fr<span class="token punctuation">;</span>       <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token class-name">RegisterMap</span><span class="token operator">*</span> <span class="token function">register_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>_reg_map<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token class-name">JavaThread</span><span class="token operator">*</span>        <span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _thread<span class="token punctuation">;</span>   <span class="token punctuation">}</span>
  <span class="token comment">// Returns the sender vframe</span>
  virtual vframe<span class="token operator">*</span> <span class="token function">sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  <span class="token comment">// Returns the next javaVFrame on the stack (skipping all other kinds of frame)</span>
  javaVFrame <span class="token operator">*</span><span class="token function">java_sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  <span class="token comment">// Answers if the this is the top vframe in the frame, i.e., if the sender vframe</span>
  <span class="token comment">// is in the caller frame</span>
  virtual bool <span class="token function">is_top</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token comment">// 返回栈顶</span>
  virtual vframe<span class="token operator">*</span> <span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  virtual bool <span class="token function">is_entry_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  virtual bool <span class="token function">is_java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  virtual bool <span class="token function">is_interpreted_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  virtual bool <span class="token function">is_compiled_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从图中可以看出<code>vframe</code>是从线程内存进行分配的，调用了<code>Thread::current()-&gt;resource_area()-&gt;allocate_bytes(size, alloc_failmode);</code>方法。 <img src="`+r+'" alt="An image"></p><h2 id="native-method-stacks" tabindex="-1"><a class="header-anchor" href="#native-method-stacks" aria-hidden="true">#</a> Native-Method-Stacks</h2><div class="hint-container tip"><p class="hint-container-title">官方文档</p><p>An implementation of the Java Virtual Machine may use conventional stacks, colloquially called &quot;C stacks,&quot; to support native methods (methods written in a language other than the Java programming language). Native method stacks may also be used by the implementation of an interpreter for the Java Virtual Machine&#39;s instruction set in a language such as C. Java Virtual Machine implementations that cannot load native methods and that do not themselves rely on conventional stacks need not supply native method stacks. If supplied, native method stacks are typically allocated per thread when each thread is created. This specification permits native method stacks either to be of a fixed size or to dynamically expand and contract as required by the computation. If the native method stacks are of a fixed size, the size of each native method stack may be chosen independently when that stack is created. A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the native method stacks, as well as, in the case of varying-size native method stacks, control over the maximum and minimum method stack sizes. The following exceptional conditions are associated with native method stacks: • If the computation in a thread requires a larger native method stack than is permitted, the Java Virtual Machine throws a StackOverflowError. • If native method stacks can be dynamically expanded and native method stack expansion is attempted but insufficient memory can be made available, or if insufficient memory can be made available to create the initial native method stack for a new thread, the Java Virtual Machine throws an OutOfMemoryError.</p></div><p>Java虚拟机的实现可以使用常规堆栈，俗称“C堆栈”，来支持本机方法（用Java编程语言以外的语言编写的方法）。本机方法堆栈也可以用于用C等语言实现Java虚拟机指令集的解释器。无法加载本机方法且本身不依赖于常规堆栈的Java虚拟机实现不需要提供本机方法堆栈。如果提供了本机方法堆栈，通常在创建每个线程时分配给每个线程。</p><p>本规范允许本机方法堆栈具有固定大小，或根据计算要求动态扩展和收缩。如果本机方法堆栈的大小固定，则可以在创建该堆栈时独立选择每个本机方法堆栈的大小。</p><p>Java虚拟机实现可以为程序员或用户提供对本机方法堆栈初始大小的控制，以及在不同大小的本机方法堆栈的情况下，对最大和最小方法堆栈大小的控制。</p><p>以下特殊条件与本机方法堆栈相关联：</p><ul><li>如果线程中的计算需要比现在更大的本机方法堆栈允许，Java虚拟机抛出StackOverflowError。</li><li>如果本机方法堆栈可以动态扩展，并尝试本机方法堆栈扩展，但内存不足，或者如果内存不足，无法为新线程创建初始本机方法堆栈，Java虚拟机将抛出OutOfMemoryError。</li></ul><p>本地方法栈使用<code>-Xoss</code>进行设定，但实际上是没有任何效果。</p><h2 id="参考材料" tabindex="-1"><a class="header-anchor" href="#参考材料" aria-hidden="true">#</a> 参考材料</h2>',26),k={href:"https://book.douban.com/subject/34907497/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://docs.oracle.com/javase/specs/jvms/se17/jvms17.pdf",target:"_blank",rel:"noopener noreferrer"},v={href:"https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/c40fbf634c90/src/share/vm/runtime/vframe.cpp",target:"_blank",rel:"noopener noreferrer"};function h(f,b){const n=i("ExternalLinkIcon");return o(),p("div",null,[d,a("ul",null,[a("li",null,[a("a",k,[s("《深入理解Java虚拟机（第3版）》"),e(n)])]),a("li",null,[a("a",m,[s("The Java® VirtualMachine Specification"),e(n)])]),a("li",null,[a("a",v,[s("vframe.cpp"),e(n)])])])])}const w=t(u,[["render",h],["__file","stacks.html.vue"]]);export{w as default};
