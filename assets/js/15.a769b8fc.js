(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{326:function(t,a,s){t.exports=s.p+"assets/img/docker-down-java.048056cc.png"},327:function(t,a,s){t.exports=s.p+"assets/img/spring-boot-run.ce0adda8.png"},328:function(t,a,s){t.exports=s.p+"assets/img/docker-mvn-down.38b34a9c.png"},329:function(t,a,s){t.exports=s.p+"assets/img/docker-build-fail.aa8ec323.png"},476:function(t,a,s){"use strict";s.r(a);var e=s(10),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"build-image"}},[t._v("Build  image")]),t._v(" "),a("h2",{attrs:{id:"准备"}},[t._v("准备")]),t._v(" "),a("p",[t._v("学习docker基本概念、dockerfile语法和机器上启动了BuildKit。")]),t._v(" "),a("h2",{attrs:{id:"概述"}},[t._v("概述")]),t._v(" "),a("p",[t._v("要部署一个java项目，需要java二进制文件、需要的依赖、系统文件等。")]),t._v(" "),a("ol",[a("li",[t._v("docker，打包使用。")]),t._v(" "),a("li",[t._v("Git客户端，拉取代码使用。")]),t._v(" "),a("li",[t._v("文本编译器，编写代码使用。")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("// 这里是你要保存项目的文件夹\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /path/to/working/directory\n// 克隆项目\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/spring-projects/spring-petclinic.git\n// 切换文件夹\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" spring-petclinic\n")])])]),a("h2",{attrs:{id:"测试项目"}},[t._v("测试项目")]),t._v(" "),a("p",[t._v("本地不使用docker进行测试，项目要求使用OpenJDK15或者15以后版本，可以官网下载，官网需要登陆，很麻烦，直接使用idea提供的工具进行下载。")]),t._v(" "),a("p",[a("img",{attrs:{src:s(326),alt:"An image"}})]),t._v(" "),a("p",[t._v("使用了mvn-wrapper，此方案好处在于不需要配置mvn环境，缺点在于每次都需要将依赖拉取一遍，比较耗时，解决此问题的方案可以搭建私服。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("// 运行项目\n./mvnw spring-boot:run\n")])])]),a("p",[a("img",{attrs:{src:s(327),alt:"An image"}})]),t._v(" "),a("h2",{attrs:{id:"创建dockerfile"}},[t._v("创建Dockerfile")]),t._v(" "),a("ol",[a("li",[t._v("拉取基础镜像，这里需要拉取OpenJDK；")])]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# syntax=docker/dockerfile:1\nFROM eclipse-temurin:17-jdk-jammy\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("创建工作文件夹；")])]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("WORKDIR /app\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("解决依赖问题，将依赖关系pom文件和mvn-wrap复制到容器中；")])]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("COPY .mvn/ .mvn\nCOPY mvnw pom.xml ./\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("下载依赖；")])]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("RUN ./mvnw dependency:resolve\n")])])]),a("p",[t._v("从图中看到下载依赖时间很长，建议使用私服解决此问题。\n"),a("img",{attrs:{src:s(328),alt:"An image"}})]),t._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[t._v("复制源代码")])]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("COPY src ./src\n")])])]),a("ol",{attrs:{start:"6"}},[a("li",[t._v("启动服务")])]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('CMD ["./mvnw", "spring-boot:run"]\n')])])]),a("ol",{attrs:{start:"7"}},[a("li",[t._v("查看完整的dockerfile")])]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('# syntax=docker/dockerfile:1\n\nFROM eclipse-temurin:17-jdk-jammy\n\nWORKDIR /app\n\nCOPY .mvn/ .mvn\nCOPY mvnw pom.xml ./\nRUN ./mvnw dependency:resolve\n\nCOPY src ./src\n\nCMD ["./mvnw", "spring-boot:run"]\n')])])]),a("h2",{attrs:{id:"常用"}},[t._v("常用")]),t._v(" "),a("p",[t._v("使用上述方案打包处理，会出现耗时长，并且打包失败问题。")]),t._v(" "),a("p",[a("img",{attrs:{src:s(329),alt:"An image"}})]),t._v(" "),a("p",[t._v("打镜像的时候，都是本地打好包，然后添加到镜像中，并用"),a("code",[t._v("java -jar")]),t._v("启动，在启动时添加"),a("code",[t._v("jvm")]),t._v("参数。")]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('// 拉取基础镜像\nFROM openjdk:12-alpine\n// 复制可启动包\nADD /target/*.jar /app.jar\n// 进行启动\nENTRYPOINT ["sh", "-c", "java  -jar /app.jar]\n\nEXPOSE 8080\n')])])]),a("h2",{attrs:{id:"镜像打tag"}},[t._v("镜像打tag")]),t._v(" "),a("p",[t._v("此问题主要是解决线上版本有问题，可以快速回滚上一版本镜像保证服务可用。")])])}),[],!1,null,null,null);a.default=n.exports}}]);