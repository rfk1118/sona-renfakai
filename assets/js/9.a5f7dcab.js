(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{427:function(t,a,s){t.exports=s.p+"assets/img/atomicInteger.ae275594.png"},428:function(t,a,s){t.exports=s.p+"assets/img/atom.b5ad72ba.jpg"},429:function(t,a,s){t.exports=s.p+"assets/img/atom-w1.b62347c3.png"},430:function(t,a,s){t.exports=s.p+"assets/img/atom-w2.37c9012d.png"},431:function(t,a,s){t.exports=s.p+"assets/img/atom-w3.50573e92.png"},432:function(t,a,s){t.exports=s.p+"assets/img/atom-w4.ffed63bc.png"},433:function(t,a,s){t.exports=s.p+"assets/img/atom-getAndSetInt.83036dad.png"},556:function(t,a,s){"use strict";s.r(a);var e=s(13),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"atomic"}},[t._v("atomic")]),t._v(" "),e("p",[t._v("本文章主要使用"),e("code",[t._v("java.util.concurrent.atomic")]),t._v("下的"),e("code",[t._v("AtomicInteger")]),t._v("来探索"),e("code",[t._v("cas")]),t._v("，由于包下大部分代码都符合ocp原则，所以使用"),e("code",[t._v("AtomicInteger")]),t._v("进行讲解。")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("分组")]),t._v(" "),e("th",{staticStyle:{"text-align":"right"}},[t._v("类")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("基础数据型")]),t._v(" "),e("td",{staticStyle:{"text-align":"right"}},[t._v("AtomicInteger AtomicBoolean AtomicLong")])]),t._v(" "),e("tr",[e("td",[t._v("数组型")]),t._v(" "),e("td",{staticStyle:{"text-align":"right"}},[t._v("AtomicIntegerArray  AtomicLongArray  AtomicReferenceArray")])]),t._v(" "),e("tr",[e("td",[t._v("字段更新器")]),t._v(" "),e("td",{staticStyle:{"text-align":"right"}},[t._v("AtomicIntegerFieldUpdater AtomicLongFieldUpdater AtomicReferenceFieldUpdater")])]),t._v(" "),e("tr",[e("td",[t._v("引用型")]),t._v(" "),e("td",{staticStyle:{"text-align":"right"}},[t._v("AtomicReference AtomicMarkableReference AtomicStampedReference")])])])]),t._v(" "),e("h2",{attrs:{id:"对象布局"}},[t._v("对象布局")]),t._v(" "),e("ol",[e("li",[t._v("查看一下"),e("code",[t._v("AtomicInteger")]),t._v("代码，这个时候我们会产生疑惑，"),e("code",[t._v("unsafe,valueOffset")]),t._v("这都是什么东西？")])]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AtomicInteger")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Number")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("Serializable")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 序列化，这个没什么好讲的")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" serialVersionUID "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("6214790243416807050L")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这个是干什么的呢？不知道")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// setup to use Unsafe.compareAndSwapInt for updates")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Unsafe")]),t._v(" unsafe "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Unsafe")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUnsafe")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这又是什么呢？")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" valueOffset"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            valueOffset "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" unsafe"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objectFieldOffset\n                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AtomicInteger")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getDeclaredField")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" ex"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ex"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 方法暂时忽略")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("使用一段代码来解释"),e("code",[t._v("unsafe,valueOffset")]),t._v("到底是什么？先引入"),e("code",[t._v("pom")]),t._v("文件。")])]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token generics"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token generics"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("openjdk"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jol"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("groupId"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token generics"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("jol"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("core"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("artifactId"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token generics"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.9")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("version"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("dependency"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("编写代码查看"),e("code",[t._v("AtomicInteger")]),t._v("对象的布局。")])]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AtomicIntegerTest")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AtomicInteger")]),t._v(" atomicInteger "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AtomicInteger")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClassLayout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseInstance")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("atomicInteger"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("toPrintable")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[t._v("输出数据，从数据中可以看到AtomicInteger.value在对象布局的OFFSET=12处，现在是使用"),e("code",[t._v("jol-core")]),t._v("进行打印的，如果我们想在代码中使用要怎么使用呢？")])]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("concurrent"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("atomic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("AtomicInteger")]),t._v(" object internals"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                           "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("01")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000001")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                           "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                           bc "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3d")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00")]),t._v(" f8 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10111100")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00111101")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("00000000")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("11111000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("134201924")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n     "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AtomicInteger")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value                       "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Instance")]),t._v(" size"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" bytes\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Space")]),t._v(" losses"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" bytes internal "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" bytes external "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" bytes total\n")])])]),e("ol",{attrs:{start:"5"}},[e("li",[t._v("让我们来debug下上面的代码，从图中可以看到"),e("code",[t._v("valueOffset=12")]),t._v("，由于对象内存布局是一样的，所以这个值在初始化的时候已经被设置到"),e("code",[t._v("valueOffset")]),t._v("上面了。\n"),e("img",{attrs:{src:s(427),alt:"An image"}})])]),t._v(" "),e("h2",{attrs:{id:"数据结构布局"}},[t._v("数据结构布局")]),t._v(" "),e("ol",[e("li",[e("a",{attrs:{href:"https://book.douban.com/subject/26912767/",target:"_blank",rel:"noopener noreferrer"}},[t._v("深入理解计算机系统（原书第 3 版）"),e("OutboundLink")],1),t._v("书中，第3.9节讲了异质的数据结构是怎么进行布局的，其如图所示：")])]),t._v(" "),e("p",[e("img",{attrs:{src:s(428),alt:"An image"}})]),t._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[e("a",{attrs:{href:"https://book.douban.com/subject/25726019/",target:"_blank",rel:"noopener noreferrer"}},[t._v("汇编语言（第3版）"),e("OutboundLink")],1),t._v("书中，8.6 寻址方式的综合应用也有相应的讲解\n"),e("img",{attrs:{src:s(429),alt:"An image"}}),t._v(" "),e("img",{attrs:{src:s(430),alt:"An image"}}),t._v(" "),e("img",{attrs:{src:s(431),alt:"An image"}}),t._v(" "),e("img",{attrs:{src:s(432),alt:"An image"}})])]),t._v(" "),e("h2",{attrs:{id:"常用方法"}},[t._v("常用方法")]),t._v(" "),e("p",[t._v("对于"),e("code",[t._v("unsafe,valueOffset")]),t._v("的困惑已经解开，来看一下常用的方法")]),t._v(" "),e("h3",{attrs:{id:"unsafe-getandsetint"}},[t._v("unsafe.getAndSetInt")]),t._v(" "),e("ol",[e("li",[t._v("进行debug这段代码，这里主要涉及到两个方法的调用"),e("code",[t._v("getIntVolatile")]),t._v("和"),e("code",[t._v("compareAndSwapInt")])])]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("     "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAndSetInt")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" var1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" var2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" var4"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" var5"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            var5 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getIntVolatile")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("var1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" var2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareAndSwapInt")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("var1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" var2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" var5"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" var4"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" var5"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[t._v("查看调用的参数，可以看到这里拿到了对象，也就是"),e("code",[t._v("基地址")]),t._v("，var2就是偏移地址")])]),t._v(" "),e("p",[e("img",{attrs:{src:s(433),alt:"An image"}})]),t._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[e("p",[e("code",[t._v("getIntVolatile")]),t._v("方法的形容如下，大概的讲解和上面数据结构布局一致，这里支持volatile语意，也就是可见性的解释，一个volatile变量的读，总是能看到（任意线程）对这个volatile变量最后的写入。")])]),t._v(" "),e("li",[e("p",[t._v("其实下面这段注释讲解的和上面"),e("RouterLink",{attrs:{to:"/languages/java/juc/atomic.html#数据结构布局"}},[t._v("数据结构布局")]),t._v("基本一致，只是对于数据使用的是"),e("code",[t._v("基地址+类型*n")]),t._v("也就是"),e("code",[t._v("B+N*S")]),t._v("，这里也可以参考"),e("a",{attrs:{href:"https://book.douban.com/subject/26912767/",target:"_blank",rel:"noopener noreferrer"}},[t._v("深入理解计算机系统（原书第 3 版）"),e("OutboundLink")],1),t._v("第3.8数组分配和访问")],1)])]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** Volatile version of {@link #getInt(Object, long)}  */")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("native")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v("     "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getIntVolatile")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" o"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" offset"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * Fetches a value from a given Java variable.\n     * More specifically, fetches a field or array element within the given\n     * object <code>o</code> at the given offset, or (if <code>o</code> is\n     * null) from the memory address whose numerical value is the given\n     * offset.\n     * <p>\n     * The results are undefined unless one of the following cases is true:\n     * <ul>\n     * <li>The offset was obtained from {@link #objectFieldOffset} on\n     * the {@link java.lang.reflect.Field} of some Java field and the object\n     * referred to by <code>o</code> is of a class compatible with that\n     * field's class.\n     *\n     * <li>The offset and object reference <code>o</code> (either null or\n     * non-null) were both obtained via {@link #staticFieldOffset}\n     * and {@link #staticFieldBase} (respectively) from the\n     * reflective {@link Field} representation of some Java field.\n     *\n     * <li>The object referred to by <code>o</code> is an array, and the offset\n     * is an integer of the form <code>B+N*S</code>, where <code>N</code> is\n     * a valid index into the array, and <code>B</code> and <code>S</code> are\n     * the values obtained by {@link #arrayBaseOffset} and {@link\n     * #arrayIndexScale} (respectively) from the array's class.  The value\n     * referred to is the <code>N</code><em>th</em> element of the array.\n     *\n     * </ul>\n     * <p>\n     * If one of the above cases is true, the call references a specific Java\n     * variable (field or array element).  However, the results are undefined\n     * if that variable is not in fact of the type returned by this method.\n     * <p>\n     * This method refers to a variable by means of two parameters, and so\n     * it provides (in effect) a <em>double-register</em> addressing mode\n     * for Java variables.  When the object reference is null, this method\n     * uses its offset as an absolute address.  This is similar in operation\n     * to methods such as {@link #getInt(long)}, which provide (in effect) a\n     * <em>single-register</em> addressing mode for non-Java variables.\n     * However, because Java variables may have a different layout in memory\n     * from non-Java variables, programmers should not assume that these\n     * two addressing modes are ever equivalent.  Also, programmers should\n     * remember that offsets from the double-register addressing mode cannot\n     * be portably confused with longs used in the single-register addressing\n     * mode.\n     *\n     * @param o Java heap object in which the variable resides, if any, else\n     *        null\n     * @param offset indication of where the variable resides in a Java heap\n     *        object, if any, else a memory address locating the variable\n     *        statically\n     * @return the value fetched from the indicated Java variable\n     * @throws RuntimeException No defined exceptions are thrown, not even\n     *         {@link NullPointerException}\n     */")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("native")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInt")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" o"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" offset"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"unsafe-compareandswapint"}},[t._v("unsafe.compareAndSwapInt")]),t._v(" "),e("ol",[e("li",[t._v("这个方法调用的是native方法，对于方法的形容是支持原子操作，也就是"),e("code",[t._v("cmpxchg")]),t._v("指令")])]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * Atomically update Java variable to <tt>x</tt> if it is currently\n     * holding <tt>expected</tt>.\n     * @return <tt>true</tt> if successful\n     */")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("native")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareAndSwapInt")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" o"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" offset"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                                  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" expected"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                                  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" x"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),e("h2",{attrs:{id:"总结"}},[t._v("总结")]),t._v(" "),e("p",[t._v("暂时只讲到了cas相关，其底层是直接操作内存地址，并且使用"),e("code",[t._v("cmpxchg")]),t._v("指令，关于其他unsafe相关功能，等到用到时在进行解释。")]),t._v(" "),e("h2",{attrs:{id:"参考"}},[t._v("参考")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/9b8c96f96a0f/src/share/classes/sun/misc/Unsafe.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("Unsafe"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://book.douban.com/subject/26912767/",target:"_blank",rel:"noopener noreferrer"}},[t._v("深入理解计算机系统（原书第 3 版）"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://book.douban.com/subject/25726019/",target:"_blank",rel:"noopener noreferrer"}},[t._v("汇编语言（第3版）"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://book.douban.com/subject/27034721/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java多线程编程实战指南（核心篇）"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://book.douban.com/subject/26591326/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java并发编程的艺术"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);