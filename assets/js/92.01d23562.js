(window.webpackJsonp=window.webpackJsonp||[]).push([[92],{498:function(t,a,s){"use strict";s.r(a);var e=s(8),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"pc-register"}},[t._v("Pc Register")]),t._v(" "),a("p",[t._v("CPU想要进行数据读写，需要与三条总线进行交互：")]),t._v(" "),a("ol",[a("li",[t._v("地址总线，根据地址总线指定存储单元、可以查找内存大小")]),t._v(" "),a("li",[t._v("数据总线，数据的传输量大小")]),t._v(" "),a("li",[t._v("控制总线，控制外部组件")])]),t._v(" "),a("p",[t._v("根据程序执行不同对内存区域也有划分，例如读区域、写区域。")]),t._v(" "),a("ol",[a("li",[t._v("数据区域可读可写，")]),t._v(" "),a("li",[t._v("程序编译后仅可以读")])]),t._v(" "),a("p",[t._v("经历高级语言发展，现在也不这么绝对了，例如Java支持字节码替换。常用架构为基于寄存器架构设计，Java使用基于栈架构设计(为了解决底层计算机指令集不同问题，中间加了一层)。")]),t._v(" "),a("h2",{attrs:{id:"基于寄存器架构设计"}},[t._v("基于寄存器架构设计")]),t._v(" "),a("p",[t._v("对于控制总线中的寄存器最具有代表的就是"),a("code",[t._v("CS、IP")]),t._v("两个寄存器，其中"),a("code",[t._v("CS")]),t._v("为代码段寄存器，"),a("code",[t._v("IP")]),t._v("为指令指针寄存器。")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),a("p",[t._v("相关内容可参考"),a("a",{attrs:{href:"https://book.douban.com/subject/35038473/",target:"_blank",rel:"noopener noreferrer"}},[t._v("《汇编语言（第4版）》"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"基于栈架构设计"}},[t._v("基于栈架构设计")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("官方文档")]),t._v(" "),a("p",[t._v("The Java Virtual Machine can support many threads of execution at once (JLS §17). Each Java Virtual Machine thread has its own pc (program counter) register. At any point, each Java Virtual Machine thread is executing the code of a single method, namely the current method (§2.6) for that thread. If that method is not native, the pc register contains the address of the Java Virtual Machine instruction currently being executed. If the method currently being executed by the thread is native, the value of the Java Virtual Machine's pc register is undefined. The Java Virtual Machine's pc register is wide enough to hold a returnAddress or a native pointer on the specific platform.")])]),t._v(" "),a("p",[t._v("Java虚拟机可以同时支持许多执行线程（JLS §17）。每个Java虚拟机线程都有自己的pc（程序计数器）寄存器。在任何时候，每个Java虚拟机线程都在执行单个方法的代码，即该线程的当前方法（§2.6）。如果该方法不是本机，pc寄存器包含当前正在执行的Java虚拟机指令的地址。如果线程当前执行的方法是本机，则Java虚拟机的pc寄存器的值未定义。Java虚拟机的pc寄存器足够宽，可以在特定平台上保存"),a("code",[t._v("returnAddress")]),t._v("或本机指针。")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("官方文档")]),t._v(" "),a("p",[t._v("The returnAddress type is used by the Java Virtual Machine's jsr, ret, and jsr_w instructions (§jsr, §ret, §jsr_w). The values of the returnAddress type are pointers to the opcodes of Java Virtual Machine instructions. Unlike the numeric primitive\ntypes, the returnAddress type does not correspond to any Java programming language type and cannot be modified by the running program.")])]),t._v(" "),a("p",[a("code",[t._v("returnAddress")]),t._v("为虚拟机操作码指针，并且不可被修改。")]),t._v(" "),a("p",[t._v("假设"),a("code",[t._v("CS")]),t._v("内容为"),a("code",[t._v("某个 class 某方法")]),t._v("文件，"),a("code",[t._v("IP")]),t._v("内容为"),a("code",[t._v("第 n 行")]),t._v("，"),a("code",[t._v("CS + IP")]),t._v("代表调用某个类某个方法，由于"),a("code",[t._v("Java")]),t._v("中没有使用寄存器模型，而是栈模型（设计通用性)，上面假设仅仅为暗喻，"),a("code",[t._v("Jvm")]),t._v("设计代表就是"),a("code",[t._v("Pc Register")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"测试案例"}},[t._v("测试案例")]),t._v(" "),a("p",[t._v("编写常用代码"),a("code",[t._v("helloworld")]),t._v("，来查看"),a("code",[t._v("pc寄存器")])]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Main")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"helloWorld"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("进行编译和反编译，执行命令如下：")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("// 编译class\n javac Main.java\n// 反编译class\n javap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" Main \n")])])]),a("p",[t._v("对于"),a("code",[t._v("class")]),t._v("文件的"),a("code",[t._v("main")]),t._v("方法可以看做是"),a("code",[t._v("CS")]),t._v("，对于"),a("code",[t._v("main")]),t._v("方法中的"),a("code",[t._v("0、3、5、8")]),t._v("可以看作行号指示器，也就是"),a("code",[t._v("IP")]),t._v("，只不过虚拟机用"),a("code",[t._v("pc寄存器")]),t._v("进行统一处理。")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// todo 其他省略")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    descriptor"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Ljava")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("lang"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("V")]),t._v("\n    flags"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ACC_PUBLIC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ACC_STATIC")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      stack"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" locals"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args_size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pc寄存器会记录运行到哪里")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" getstatic     #"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Field java/lang/System.out:Ljava/io/PrintStream;")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ldc           #"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// String helloWorld")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" invokevirtual #"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Method java/io/PrintStream.println:(Ljava/lang/String;)V")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LineNumberTable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        line "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n        line "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\n")])])]),a("h3",{attrs:{id:"源码"}},[t._v("源码")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("hotspot")]),t._v("源码中查找"),a("code",[t._v("frame.hpp")]),t._v("，具体情况如下：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" frame "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n  intptr_t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _sp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// stack pointer (from Thread::last_Java_sp)")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pc寄存器，也就是程序计数器")]),t._v("\n  address   _pc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// program counter (the next instruction after the call)")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// todo 其他省略")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pc：返回此帧将正常继续的pc。")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 它必须指向下一条要执行的指令的开头")]),t._v("\n  address "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("pc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" _pc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// debug使用，也就是未优化前跳转指针")]),t._v("\n  address "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("raw_pc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置新的处理opcode地址")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set_pc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" address   newpc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// patching operations")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("patch_pc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" address pc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// todo 其他省略")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"总结"}},[t._v("总结")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Pc Register")]),t._v("是"),a("code",[t._v("Java")]),t._v("指示当前线程运行到哪行"),a("code",[t._v("opcode")]),t._v("的指示器，与汇编，Go语言中的"),a("code",[t._v("CS、IP")]),t._v("等效。")]),t._v(" "),a("li",[a("code",[t._v("Pc Register")]),t._v("是线程独有的，"),a("code",[t._v("Pc Register")]),t._v("不存在oom，其只占线程空间中最小内存")])]),t._v(" "),a("h2",{attrs:{id:"参考材料"}},[t._v("参考材料")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://book.douban.com/subject/35038473/",target:"_blank",rel:"noopener noreferrer"}},[t._v("《汇编语言（第4版）》"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.oracle.com/javase/specs/jvms/se17/jvms17.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Java® VirtualMachine Specification"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/c40fbf634c90/src/share/vm/runtime/frame.cpp",target:"_blank",rel:"noopener noreferrer"}},[t._v("frame.cpp"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);