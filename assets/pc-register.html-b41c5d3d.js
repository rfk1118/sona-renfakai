import{_ as o,V as c,W as p,Y as n,a1 as a,Z as e,a0 as t,F as i}from"./framework-e54e0297.js";const l={},r=t('<h1 id="pc寄存器" tabindex="-1"><a class="header-anchor" href="#pc寄存器" aria-hidden="true">#</a> Pc寄存器</h1><p>CPU想要进行数据读写，需要与三条总线进行交互：</p><ol><li>地址总线，根据地址总线指定存储单元、可以查找内存大小</li><li>数据总线，数据的传输量大小</li><li>控制总线，控制外部组件</li></ol><p>根据程序执行不同对内存区域也有划分，例如读区域、写区域。</p><ol><li>数据区域可读可写，</li><li>程序编译后仅可以读</li></ol><p>经历高级语言发展，现在也不这么绝对了，例如Java支持字节码替换。常用架构为基于寄存器架构设计，Java使用基于栈架构设计(为了解决底层计算机指令集不同问题，中间加了一层)。</p><h2 id="基于寄存器架构设计" tabindex="-1"><a class="header-anchor" href="#基于寄存器架构设计" aria-hidden="true">#</a> 基于寄存器架构设计</h2><p>对于控制总线中的寄存器最具有代表的就是<code>CS、IP</code>两个寄存器，其中<code>CS</code>为代码段寄存器，<code>IP</code>为指令指针寄存器。</p>',8),d={class:"hint-container tip"},u=n("p",{class:"hint-container-title"},"提示",-1),k={href:"https://book.douban.com/subject/35038473/",target:"_blank",rel:"noopener noreferrer"},v=t(`<h2 id="基于栈架构设计" tabindex="-1"><a class="header-anchor" href="#基于栈架构设计" aria-hidden="true">#</a> 基于栈架构设计</h2><div class="hint-container tip"><p class="hint-container-title">官方文档</p><p>The Java Virtual Machine can support many threads of execution at once (JLS §17). Each Java Virtual Machine thread has its own pc (program counter) register. At any point, each Java Virtual Machine thread is executing the code of a single method, namely the current method (§2.6) for that thread. If that method is not native, the pc register contains the address of the Java Virtual Machine instruction currently being executed. If the method currently being executed by the thread is native, the value of the Java Virtual Machine&#39;s pc register is undefined. The Java Virtual Machine&#39;s pc register is wide enough to hold a returnAddress or a native pointer on the specific platform.</p></div><p>Java虚拟机可以同时支持许多执行线程（JLS §17）。每个Java虚拟机线程都有自己的pc（程序计数器）寄存器。在任何时候，每个Java虚拟机线程都在执行单个方法的代码，即该线程的当前方法（§2.6）。如果该方法不是本机，pc寄存器包含当前正在执行的Java虚拟机指令的地址。如果线程当前执行的方法是本机，则Java虚拟机的pc寄存器的值未定义。Java虚拟机的pc寄存器足够宽，可以在特定平台上保存<code>returnAddress</code>或本机指针。</p><div class="hint-container tip"><p class="hint-container-title">官方文档</p><p>The returnAddress type is used by the Java Virtual Machine&#39;s jsr, ret, and jsr_w instructions (§jsr, §ret, §jsr_w). The values of the returnAddress type are pointers to the opcodes of Java Virtual Machine instructions. Unlike the numeric primitive types, the returnAddress type does not correspond to any Java programming language type and cannot be modified by the running program.</p></div><p><code>returnAddress</code>为虚拟机操作码指针，并且不可被修改。</p><p>假设<code>CS</code>内容为<code>某个 class 某方法</code>文件，<code>IP</code>内容为<code>第 n 行</code>，<code>CS + IP</code>代表调用某个类某个方法，由于<code>Java</code>中没有使用寄存器模型，而是栈模型（设计通用性)，上面假设仅仅为暗喻，<code>Jvm</code>设计代表就是<code>Pc Register</code>。</p><h3 id="测试案例" tabindex="-1"><a class="header-anchor" href="#测试案例" aria-hidden="true">#</a> 测试案例</h3><p>编写常用代码<code>helloworld</code>，来查看<code>pc寄存器</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;helloWorld&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进行编译和反编译，执行命令如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>// 编译class
 javac Main.java
// 反编译class
 javap <span class="token parameter variable">-v</span> Main
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于<code>class</code>文件的<code>main</code>方法可以看做是<code>CS</code>，对于<code>main</code>方法中的<code>0、3、5、8</code>可以看作行号指示器，也就是<code>IP</code>，只不过虚拟机用<code>pc寄存器</code>进行统一处理。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// todo 其他省略</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>
    flags<span class="token operator">:</span> <span class="token constant">ACC_PUBLIC</span><span class="token punctuation">,</span> <span class="token constant">ACC_STATIC</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token comment">// pc寄存器会记录运行到哪里</span>
         <span class="token number">0</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment">// String helloWorld</span>
         <span class="token number">5</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
         <span class="token number">8</span><span class="token operator">:</span> <span class="token keyword">return</span>
      <span class="token class-name">LineNumberTable</span><span class="token operator">:</span>
        line <span class="token number">5</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">6</span><span class="token operator">:</span> <span class="token number">8</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="源码" tabindex="-1"><a class="header-anchor" href="#源码" aria-hidden="true">#</a> 源码</h3><p>在<code>hotspot</code>源码中查找<code>frame.hpp</code>，具体情况如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> frame <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  intptr_t<span class="token operator">*</span> _sp<span class="token punctuation">;</span> <span class="token comment">// stack pointer (from Thread::last_Java_sp)</span>
  <span class="token comment">// pc寄存器，也就是程序计数器</span>
  address   _pc<span class="token punctuation">;</span> <span class="token comment">// program counter (the next instruction after the call)</span>
  <span class="token comment">// todo 其他省略</span>
  <span class="token comment">// pc：返回此帧将正常继续的pc。</span>
  <span class="token comment">// 它必须指向下一条要执行的指令的开头</span>
  address <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>             <span class="token punctuation">{</span> <span class="token keyword">return</span> _pc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token comment">// debug使用，也就是未优化前跳转指针</span>
  address <span class="token function">raw_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置新的处理opcode地址</span>
  <span class="token keyword">void</span> <span class="token function">set_pc</span><span class="token punctuation">(</span> address   newpc <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// patching operations</span>
  <span class="token keyword">void</span>   <span class="token function">patch_pc</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> address pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// todo 其他省略</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><ul><li><code>Pc Register</code>是<code>Java</code>指示当前线程运行到哪行<code>opcode</code>的指示器，与汇编，Go语言中的<code>CS、IP</code>等效。</li><li><code>Pc Register</code>是线程独有的，<code>Pc Register</code>不存在oom，其只占线程空间中最小内存</li></ul><h2 id="参考材料" tabindex="-1"><a class="header-anchor" href="#参考材料" aria-hidden="true">#</a> 参考材料</h2>`,19),m={href:"https://book.douban.com/subject/35038473/",target:"_blank",rel:"noopener noreferrer"},h={href:"https://docs.oracle.com/javase/specs/jvms/se17/jvms17.pdf",target:"_blank",rel:"noopener noreferrer"},b={href:"https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/c40fbf634c90/src/share/vm/runtime/frame.cpp",target:"_blank",rel:"noopener noreferrer"};function g(f,_){const s=i("ExternalLinkIcon");return c(),p("div",null,[r,n("div",d,[u,n("p",null,[a("相关内容可参考"),n("a",k,[a("《汇编语言（第4版）》"),e(s)])])]),v,n("ul",null,[n("li",null,[n("a",m,[a("《汇编语言（第4版）》"),e(s)])]),n("li",null,[n("a",h,[a("The Java® VirtualMachine Specification"),e(s)])]),n("li",null,[n("a",b,[a("frame.cpp"),e(s)])])])])}const j=o(l,[["render",g],["__file","pc-register.html.vue"]]);export{j as default};
