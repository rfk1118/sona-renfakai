import{_ as p,V as o,W as c,X as n,a0 as s,Y as e,$ as t,F as l}from"./framework-fd210779.js";const i="/assets/hashmap-select-2115a793.jpg",u={},r=t(`<h1 id="openselector" tabindex="-1"><a class="header-anchor" href="#openselector" aria-hidden="true">#</a> OpenSelector</h1><h3 id="动机" tabindex="-1"><a class="header-anchor" href="#动机" aria-hidden="true">#</a> 动机</h3><p>3ce9ab2e Trustin Lee <a href="mailto:t@motd.kr">t@motd.kr</a> on 2013/6/10 at 11:00 下午 Replace the sun.nio.ch. SelectorImpl.selectedKeys with faster one 替换 SelectorImpl.selectedKeys 使用更快的方式</p><ul><li>Yield much less garbage 更少的垃圾回收</li><li>Slight performance gain (1~2%) 性能略有提高 SelectorImpl 基础代码</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SelectorImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSelector</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectedKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> publicKeys<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> publicSelectedKeys<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>底层:</p><p><img src="`+i+`" alt="An image"></p><p>当我看 <code>openSelector</code> 这个方法时候，我发现这里这么一大段代码， 只是感觉感觉这里写的很妙，但是完全很茫然，等我看到动机后，就完全明白了。</p><h3 id="原始代码" tabindex="-1"><a class="header-anchor" href="#原始代码" aria-hidden="true">#</a> 原始代码</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">Selector</span> <span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> provider<span class="token punctuation">.</span><span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open a new selector&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>优化前的代码是不是很简单，直接创建了一个选择器，我们写 demo 时候也会这么写。</p><h3 id="优化提交的代码" tabindex="-1"><a class="header-anchor" href="#优化提交的代码" aria-hidden="true">#</a> 优化提交的代码</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// 判断是否打开了优化</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">DISABLE_KEYSET_OPTIMIZATION</span> <span class="token operator">=</span>
            <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;io.netty.noKeySetOptimization&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">Selector</span> <span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Selector</span> selector<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            selector <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open a new selector&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果没有优化直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_KEYSET_OPTIMIZATION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> selector<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token comment">// 数组的set结果</span>
            <span class="token class-name">SelectedSelectionKeySet</span> selectedKeySet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelectedSelectionKeySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> selectorImplClass <span class="token operator">=</span>
                    <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;sun.nio.ch.SelectorImpl&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            selectorImplClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 反射</span>
            <span class="token class-name">Field</span> selectedKeysField <span class="token operator">=</span> selectorImplClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;selectedKeys&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> publicSelectedKeysField <span class="token operator">=</span> selectorImplClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;publicSelectedKeys&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            selectedKeysField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            publicSelectedKeysField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 反射替换值</span>
            selectedKeysField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> selectedKeySet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            publicSelectedKeysField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> selectedKeySet<span class="token punctuation">)</span><span class="token punctuation">;</span>

            selectedKeys <span class="token operator">=</span> selectedKeySet<span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Instrumented an optimized java.util.Set into: {}&quot;</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            selectedKeys <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to instrument an optimized java.util.Set into: {}&quot;</span><span class="token punctuation">,</span> selector<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> selector<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SelectedSelectionKeySet</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keysA<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> keysASize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keysB<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> keysBSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isA <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="优化理论" tabindex="-1"><a class="header-anchor" href="#优化理论" aria-hidden="true">#</a> 优化理论</h3>`,14),k={href:"https://book.douban.com/subject/26912767/",target:"_blank",rel:"noopener noreferrer"},d=t(`<p>java 中的应用 <code>RandomAccess</code> 其中有一段注释为</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token operator">=</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&amp;</span>lt<span class="token punctuation">;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
         list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

     runs faster than <span class="token keyword">this</span> loop<span class="token operator">:</span>

     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> i<span class="token operator">=</span>list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="代码权限" tabindex="-1"><a class="header-anchor" href="#代码权限" aria-hidden="true">#</a> 代码权限</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>   <span class="token class-name">Object</span> maybeSelectorImplClass <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;sun.nio.ch.SelectorImpl&quot;</span><span class="token punctuation">,</span>
                            <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> cause<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码主要是关于代码权限的问题，比如 B 系统没有 C 文件夹写的权限，但是 A 有 C 文件夹写的权限，B 系统委托给 A 系统调用，使用 <code>AccessController.doPrivileged</code> 可以解决权限链向上检查问题，从 A 系统有权限就终止了，想深入了解请自行查找资料。</p><h3 id="版本优化" tabindex="-1"><a class="header-anchor" href="#版本优化" aria-hidden="true">#</a> 版本优化</h3><p>支持 JDK9 及以上版本 动机：在 JDK8 使用反射替换 <code>key set</code> ，在 JDK9 以后在域反射使用 <code>setAccessible(true)</code> 不在生效。</p><p>NioEventLoop should also use our special SelectionKeySet on Java9 and later. (#8260) Motivation: In Java8 and earlier we used reflection to replace the used key set if not otherwise told. This does not work on Java9 and later without special flags as its not possible to call setAccessible(true) on the Field anymore. Modifications: - Use Unsafe to instrument the Selector with out special set when sun.misc. Unsafe is present and we are using Java9+. Result: NIO transport produce less GC on Java9 and later as well.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">javaVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">9</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">hasUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="selectortuple" tabindex="-1"><a class="header-anchor" href="#selectortuple" aria-hidden="true">#</a> SelectorTuple</h3><p>持续优化带来的产物</p>`,11),v={href:"https://github.com/netty/netty/issues/6058",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/netty/netty/issues/6607",target:"_blank",rel:"noopener noreferrer"},b=n("h3",{id:"总结",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#总结","aria-hidden":"true"},"#"),s(" 总结")],-1),h=n("p",null,"减少复杂度学习源码复杂度，可以在 debug 代码时候可以回归到原始状态。",-1);function y(g,f){const a=l("ExternalLinkIcon");return o(),c("div",null,[r,n("p",null,[s("替换 hashset 为数组，因为数组支持基地址+偏移地址进行遍历，节省更多空间，遍历更快。可参考"),n("a",k,[s("深入理解计算机系统（原书第 3 版）"),e(a)]),s(" ( 3.8 数组分配和访问 - 3.9 异质的数据结构)")]),d,n("ul",null,[n("li",null,[n("a",v,[s("Use a single array in SelectedSelectionKeySet"),e(a)])]),n("li",null,[n("a",m,[s("NioEventLoop#rebuildSelector0 throws ClassCastException"),e(a)])])]),b,h])}const S=p(u,[["render",y],["__file","open-selector.html.vue"]]);export{S as default};
