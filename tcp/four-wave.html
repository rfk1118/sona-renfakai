<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>四次挥手 | 智慧不可赐！</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <meta name="description" content="因果不可改、智慧不可赐、真法不可说、无缘不能渡！">
    
    <link rel="preload" href="/assets/css/0.styles.7f49ab7e.css" as="style"><link rel="preload" href="/assets/js/app.f73a7032.js" as="script"><link rel="preload" href="/assets/js/2.cc934d9f.js" as="script"><link rel="preload" href="/assets/js/7.210a742e.js" as="script"><link rel="prefetch" href="/assets/js/10.4f230049.js"><link rel="prefetch" href="/assets/js/11.9aec2f5f.js"><link rel="prefetch" href="/assets/js/12.78791d1b.js"><link rel="prefetch" href="/assets/js/13.bb940fbe.js"><link rel="prefetch" href="/assets/js/14.a8126221.js"><link rel="prefetch" href="/assets/js/15.d40061a6.js"><link rel="prefetch" href="/assets/js/16.2a736bda.js"><link rel="prefetch" href="/assets/js/17.e7e13b3a.js"><link rel="prefetch" href="/assets/js/18.ee69fef5.js"><link rel="prefetch" href="/assets/js/19.b386e58d.js"><link rel="prefetch" href="/assets/js/20.e515fba2.js"><link rel="prefetch" href="/assets/js/21.670259be.js"><link rel="prefetch" href="/assets/js/22.7b1bdc0a.js"><link rel="prefetch" href="/assets/js/23.8b6df68e.js"><link rel="prefetch" href="/assets/js/24.b45d118b.js"><link rel="prefetch" href="/assets/js/25.0d9d6aba.js"><link rel="prefetch" href="/assets/js/26.acf92556.js"><link rel="prefetch" href="/assets/js/27.26dddeaa.js"><link rel="prefetch" href="/assets/js/28.5e481592.js"><link rel="prefetch" href="/assets/js/29.ba5ddc95.js"><link rel="prefetch" href="/assets/js/3.c76177ad.js"><link rel="prefetch" href="/assets/js/30.0539ad72.js"><link rel="prefetch" href="/assets/js/31.77160ca1.js"><link rel="prefetch" href="/assets/js/32.6cd96739.js"><link rel="prefetch" href="/assets/js/33.ebda435d.js"><link rel="prefetch" href="/assets/js/34.18c5ff6a.js"><link rel="prefetch" href="/assets/js/35.0d83e936.js"><link rel="prefetch" href="/assets/js/36.958c9c4a.js"><link rel="prefetch" href="/assets/js/37.81749598.js"><link rel="prefetch" href="/assets/js/38.03f5e26e.js"><link rel="prefetch" href="/assets/js/39.29d28cbd.js"><link rel="prefetch" href="/assets/js/4.3aee77bb.js"><link rel="prefetch" href="/assets/js/40.e5da55ae.js"><link rel="prefetch" href="/assets/js/41.c94ced0d.js"><link rel="prefetch" href="/assets/js/42.35ce7abc.js"><link rel="prefetch" href="/assets/js/43.128f3ca3.js"><link rel="prefetch" href="/assets/js/44.8fd75ee7.js"><link rel="prefetch" href="/assets/js/45.cad8307a.js"><link rel="prefetch" href="/assets/js/46.084bfc92.js"><link rel="prefetch" href="/assets/js/47.8176825a.js"><link rel="prefetch" href="/assets/js/48.099d2395.js"><link rel="prefetch" href="/assets/js/49.bd7661c2.js"><link rel="prefetch" href="/assets/js/5.5fa74005.js"><link rel="prefetch" href="/assets/js/50.1a095908.js"><link rel="prefetch" href="/assets/js/51.118b218e.js"><link rel="prefetch" href="/assets/js/52.735c8db9.js"><link rel="prefetch" href="/assets/js/53.24ec3bc5.js"><link rel="prefetch" href="/assets/js/54.de17f4c3.js"><link rel="prefetch" href="/assets/js/55.a5a901f3.js"><link rel="prefetch" href="/assets/js/56.5fcb19b9.js"><link rel="prefetch" href="/assets/js/57.3ac6c9f4.js"><link rel="prefetch" href="/assets/js/58.923ce778.js"><link rel="prefetch" href="/assets/js/59.5e0f07af.js"><link rel="prefetch" href="/assets/js/6.eed41a84.js"><link rel="prefetch" href="/assets/js/60.8ab01490.js"><link rel="prefetch" href="/assets/js/61.64d3396f.js"><link rel="prefetch" href="/assets/js/62.05417ba8.js"><link rel="prefetch" href="/assets/js/63.44762ab9.js"><link rel="prefetch" href="/assets/js/64.b4d7bd5b.js"><link rel="prefetch" href="/assets/js/65.f096c8dd.js"><link rel="prefetch" href="/assets/js/66.86c9023c.js"><link rel="prefetch" href="/assets/js/67.7629a6a7.js"><link rel="prefetch" href="/assets/js/68.9663da33.js"><link rel="prefetch" href="/assets/js/69.85456145.js"><link rel="prefetch" href="/assets/js/70.2e568abc.js"><link rel="prefetch" href="/assets/js/71.41843f8f.js"><link rel="prefetch" href="/assets/js/72.03df9fc5.js"><link rel="prefetch" href="/assets/js/73.2cefe3bf.js"><link rel="prefetch" href="/assets/js/74.880dd252.js"><link rel="prefetch" href="/assets/js/75.160d6f27.js"><link rel="prefetch" href="/assets/js/76.6128638e.js"><link rel="prefetch" href="/assets/js/77.feb46cc4.js"><link rel="prefetch" href="/assets/js/78.ae8d5b88.js"><link rel="prefetch" href="/assets/js/79.3d05ba0c.js"><link rel="prefetch" href="/assets/js/8.7d069de9.js"><link rel="prefetch" href="/assets/js/80.ff7cb1db.js"><link rel="prefetch" href="/assets/js/81.326e2130.js"><link rel="prefetch" href="/assets/js/82.18e47883.js"><link rel="prefetch" href="/assets/js/83.d0de6c41.js"><link rel="prefetch" href="/assets/js/84.5eeb8f0f.js"><link rel="prefetch" href="/assets/js/9.acba7227.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7f49ab7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">智慧不可赐！</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/introduction/about-me.html" class="sidebar-link">作者</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Netty</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>计算机网络</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tcp/tree-shake-hands.html" class="sidebar-link">三次握手</a></li><li><a href="/tcp/four-wave.html" aria-current="page" class="active sidebar-link">四次挥手</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="四次挥手">四次挥手</h1> <h3 id="四次挥手-2">四次挥手</h3> <ol><li>查看四次挥手基本流程图，也就是下图重的 segment4-7</li></ol> <p><img src="/assets/img/three-hand.8ad070cb.png" alt="An image"></p> <ol start="2"><li>关于<code>FIN ACK</code>请查看<a href="/tcp/tree-shake-hands.html">上篇文章</a>三次握手</li> <li>使用上一章的<a href="https://github.com/sona0402/netty/blob/master/src/main/java/channelhandlers/TcpDnsClient.java" target="_blank" rel="noopener noreferrer">代码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>进行 DNS 查询，并使用<code>WireShark</code>进行抓包，抓包命令 filter 使用<code>tcp.port == 53</code>，抓到的结果如下图所示:</li></ol> <p><img src="/assets/img/four-1.9ff15e5a.jpg" alt="An image"></p> <ol start="4"><li>因为 TCP 是双工的，所以涉及到半关问题，一般情况下需要 4 次挥手，在合适的场景使用 3 次挥手（合并一次挥手）</li></ol> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>There are six flag bits in the TCP header. One or more of them can be turned on at the same time. We briefly mention their use here and discuss each flag in more detail in later chapters.</p> <p>在这里有一句话， <code>One or more of them can be turned on at the same time.</code> 在一个段中可能会出现多个 <code>flag</code></p> <ul><li>URG The urgent pointer is valid (Section 20.8).</li> <li>ACK The acknowledgment number is valid.</li> <li>PSH The receiver should pass this data to the application as soon as possible (Section 20.5).</li> <li>RST Reset the connection (Section 18.7).</li> <li>SYN Synchronize sequence numbers to initiate a connection. This flag and the next are described in Chapter 18.</li> <li>FIN The sender is finished sending data.</li></ul></div> <ol><li>来看一下三次挥手，client 发送完数据，发送一个 FIN 数据段，其中 client 序列号为 36</li></ol> <p><img src="/assets/img/four-3.8993bf80.jpg" alt="An image"></p> <ol start="2"><li>由于 server 数据发送完了，所以是可以直接断开的，所以这里将<code>FIN ACK</code>进行合并了，对 client 的序号进行+1 确认，并给出 server 序号 52，这个时候 server 对 client 的写连接已经关闭，并发送读断开的 FIN</li></ol> <p><img src="/assets/img/four-4.d5a13be9.jpg" alt="An image"></p> <ol start="3"><li>client 收到后，对 server 序号+1，发送到 server，让 server 进行确认</li></ol> <p><img src="/assets/img/four-5.9b1f53ac.jpg" alt="An image"></p> <h3 id="半关">半关</h3> <ol><li>查看半关案例，图来自《TCP IP 协议详解卷一：协议》</li></ol> <p><img src="/assets/img/half-close.2841b301.jpg" alt="An image"></p> <ol start="2"><li>如果想产生 4 次挥手，最好的测试就是 client 发送数据， 发送写数据请求，然后 server 发送数据，使用<a href="https://github.com/sona0402/netty/tree/master/src/main/java/tcp" target="_blank" rel="noopener noreferrer">代码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>进行半关测试</li> <li>使用 wireshark 抓本地环绕，使用<code>tcp.port == 4444</code>进行过滤查看</li></ol> <p><img src="/assets/img/four-2-1.a228b9bc.jpg" alt="An image"></p> <ol start="4"><li>no.329 client 发送 FIN</li> <li>no.330 server ACK</li> <li>no.415 server 发送数据</li></ol> <p><img src="/assets/img/415.a1ef3e0e.jpg" alt="An image"></p> <ol start="7"><li>no.416 数据的 data 的 ACK</li> <li>no.417 server 发出 FIN</li> <li>no.418 client 发出 ACK</li></ol> <h3 id="参考材料">参考材料</h3> <p><a href="https://book.douban.com/subject/1088054/" target="_blank" rel="noopener noreferrer">TCP/IP 详解 卷 1：协议<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tcp/tree-shake-hands.html" class="prev">
        三次握手
      </a></span> <!----></p></div> </main></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/assets/js/app.f73a7032.js" defer></script><script src="/assets/js/2.cc934d9f.js" defer></script><script src="/assets/js/7.210a742e.js" defer></script>
  </body>
</html>
