<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>safepoint | 天道酬勤。</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <meta name="description" content="天道酬勤">
    
    <link rel="preload" href="/assets/css/0.styles.4701c6d9.css" as="style"><link rel="preload" href="/assets/js/app.6347abd9.js" as="script"><link rel="preload" href="/assets/js/2.b0206109.js" as="script"><link rel="preload" href="/assets/js/93.a953f7ea.js" as="script"><link rel="prefetch" href="/assets/js/10.0e285cba.js"><link rel="prefetch" href="/assets/js/100.e337dfdb.js"><link rel="prefetch" href="/assets/js/101.018cf288.js"><link rel="prefetch" href="/assets/js/102.671f4809.js"><link rel="prefetch" href="/assets/js/103.44ae5a33.js"><link rel="prefetch" href="/assets/js/104.d25df6cf.js"><link rel="prefetch" href="/assets/js/105.c67883b7.js"><link rel="prefetch" href="/assets/js/106.163ca45b.js"><link rel="prefetch" href="/assets/js/107.1716d9d7.js"><link rel="prefetch" href="/assets/js/108.7b28feae.js"><link rel="prefetch" href="/assets/js/109.f55eebac.js"><link rel="prefetch" href="/assets/js/11.278e7810.js"><link rel="prefetch" href="/assets/js/110.f0d59daf.js"><link rel="prefetch" href="/assets/js/111.8960b1c2.js"><link rel="prefetch" href="/assets/js/112.731791f4.js"><link rel="prefetch" href="/assets/js/113.b15e3b8f.js"><link rel="prefetch" href="/assets/js/114.a904e315.js"><link rel="prefetch" href="/assets/js/115.562be5b1.js"><link rel="prefetch" href="/assets/js/116.035e4e92.js"><link rel="prefetch" href="/assets/js/117.e2d02104.js"><link rel="prefetch" href="/assets/js/118.5bbdf281.js"><link rel="prefetch" href="/assets/js/12.fa6b677d.js"><link rel="prefetch" href="/assets/js/13.9317c55b.js"><link rel="prefetch" href="/assets/js/14.b6cbc14d.js"><link rel="prefetch" href="/assets/js/15.e85230a7.js"><link rel="prefetch" href="/assets/js/16.78973ac6.js"><link rel="prefetch" href="/assets/js/17.66850fb0.js"><link rel="prefetch" href="/assets/js/18.29b57074.js"><link rel="prefetch" href="/assets/js/19.d8bed48f.js"><link rel="prefetch" href="/assets/js/20.96d237f0.js"><link rel="prefetch" href="/assets/js/21.6193196e.js"><link rel="prefetch" href="/assets/js/22.8679bb09.js"><link rel="prefetch" href="/assets/js/23.962940c2.js"><link rel="prefetch" href="/assets/js/24.48d4512e.js"><link rel="prefetch" href="/assets/js/25.79aec2d4.js"><link rel="prefetch" href="/assets/js/26.f9912292.js"><link rel="prefetch" href="/assets/js/27.33d7e3f2.js"><link rel="prefetch" href="/assets/js/28.f0c75de8.js"><link rel="prefetch" href="/assets/js/29.dae0d84e.js"><link rel="prefetch" href="/assets/js/3.2706a1c0.js"><link rel="prefetch" href="/assets/js/30.0cdbc725.js"><link rel="prefetch" href="/assets/js/31.e7edfc67.js"><link rel="prefetch" href="/assets/js/32.29341ca7.js"><link rel="prefetch" href="/assets/js/33.dcfc9799.js"><link rel="prefetch" href="/assets/js/34.17325c2f.js"><link rel="prefetch" href="/assets/js/35.bebac797.js"><link rel="prefetch" href="/assets/js/36.6695f942.js"><link rel="prefetch" href="/assets/js/37.e4ea5767.js"><link rel="prefetch" href="/assets/js/38.1b52cb84.js"><link rel="prefetch" href="/assets/js/39.9eab4400.js"><link rel="prefetch" href="/assets/js/4.5cb37f1f.js"><link rel="prefetch" href="/assets/js/40.0b471e00.js"><link rel="prefetch" href="/assets/js/41.ca82eb29.js"><link rel="prefetch" href="/assets/js/42.bf5efa5e.js"><link rel="prefetch" href="/assets/js/43.2d001508.js"><link rel="prefetch" href="/assets/js/44.61b345af.js"><link rel="prefetch" href="/assets/js/45.ce5f90d7.js"><link rel="prefetch" href="/assets/js/46.7bbc5ee8.js"><link rel="prefetch" href="/assets/js/47.d00c43ac.js"><link rel="prefetch" href="/assets/js/48.500fff0a.js"><link rel="prefetch" href="/assets/js/49.61e21338.js"><link rel="prefetch" href="/assets/js/5.d47fb4a3.js"><link rel="prefetch" href="/assets/js/50.456e6bce.js"><link rel="prefetch" href="/assets/js/51.98e1f3d1.js"><link rel="prefetch" href="/assets/js/52.e1e8509f.js"><link rel="prefetch" href="/assets/js/53.fdc66672.js"><link rel="prefetch" href="/assets/js/54.5f95ad93.js"><link rel="prefetch" href="/assets/js/55.cb594ceb.js"><link rel="prefetch" href="/assets/js/56.8254c450.js"><link rel="prefetch" href="/assets/js/57.b9f7cb91.js"><link rel="prefetch" href="/assets/js/58.c23c1bca.js"><link rel="prefetch" href="/assets/js/59.cba27e9a.js"><link rel="prefetch" href="/assets/js/6.9824ac86.js"><link rel="prefetch" href="/assets/js/60.0dc34fb1.js"><link rel="prefetch" href="/assets/js/61.77c072d4.js"><link rel="prefetch" href="/assets/js/62.512facd5.js"><link rel="prefetch" href="/assets/js/63.ad519f9f.js"><link rel="prefetch" href="/assets/js/64.2a712b76.js"><link rel="prefetch" href="/assets/js/65.eec4a86c.js"><link rel="prefetch" href="/assets/js/66.fa128543.js"><link rel="prefetch" href="/assets/js/67.4d20b41d.js"><link rel="prefetch" href="/assets/js/68.04f0bfde.js"><link rel="prefetch" href="/assets/js/69.d361d42f.js"><link rel="prefetch" href="/assets/js/7.456ded86.js"><link rel="prefetch" href="/assets/js/70.012f2397.js"><link rel="prefetch" href="/assets/js/71.a75f4924.js"><link rel="prefetch" href="/assets/js/72.ac41e934.js"><link rel="prefetch" href="/assets/js/73.e6863649.js"><link rel="prefetch" href="/assets/js/74.bc03694a.js"><link rel="prefetch" href="/assets/js/75.4d864fa9.js"><link rel="prefetch" href="/assets/js/76.cebd2e48.js"><link rel="prefetch" href="/assets/js/77.4fb0d022.js"><link rel="prefetch" href="/assets/js/78.6bc5ea78.js"><link rel="prefetch" href="/assets/js/79.efb6cc9e.js"><link rel="prefetch" href="/assets/js/8.70451cf8.js"><link rel="prefetch" href="/assets/js/80.5005a0f6.js"><link rel="prefetch" href="/assets/js/81.8786269d.js"><link rel="prefetch" href="/assets/js/82.a7b450f3.js"><link rel="prefetch" href="/assets/js/83.298dfaea.js"><link rel="prefetch" href="/assets/js/84.1411054b.js"><link rel="prefetch" href="/assets/js/85.b22d55b4.js"><link rel="prefetch" href="/assets/js/86.e55824b8.js"><link rel="prefetch" href="/assets/js/87.2764bf57.js"><link rel="prefetch" href="/assets/js/88.604095b1.js"><link rel="prefetch" href="/assets/js/89.cf2a3aa7.js"><link rel="prefetch" href="/assets/js/9.3419e3b4.js"><link rel="prefetch" href="/assets/js/90.cc86ca21.js"><link rel="prefetch" href="/assets/js/91.8232dc99.js"><link rel="prefetch" href="/assets/js/92.bd8150b0.js"><link rel="prefetch" href="/assets/js/94.0a69171b.js"><link rel="prefetch" href="/assets/js/95.afc1608a.js"><link rel="prefetch" href="/assets/js/96.27ea6cc9.js"><link rel="prefetch" href="/assets/js/97.da711f53.js"><link rel="prefetch" href="/assets/js/98.3621ef18.js"><link rel="prefetch" href="/assets/js/99.e7698df5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4701c6d9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">天道酬勤。</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/introduction/" class="sidebar-link">前言</a></li><li><section class="sidebar-group depth-0"><a href="/middleware/" class="sidebar-heading clickable"><span>中间件</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/middleware/netty/" class="sidebar-heading clickable open"><span>Netty</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><a href="/middleware/netty/knowledge/" class="sidebar-heading clickable open"><span>基础知识</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/middleware/netty/knowledge/reference.html" class="sidebar-link">参考资料</a></li><li><a href="/middleware/netty/knowledge/read-source.html" class="sidebar-link">如何读源码</a></li><li><a href="/middleware/netty/knowledge/quick-start.html" class="sidebar-link">快速上手</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>Reactor</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/middleware/netty/reactor/single.html" class="sidebar-link">Single</a></li><li><a href="/middleware/netty/reactor/multiple.html" class="sidebar-link">Multiple</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>EventLoop</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/middleware/netty/nio/event-loop/nio-event-loop-group.html" class="sidebar-link">EventLoopGroup</a></li><li><a href="/middleware/netty/nio/event-loop/nio-event-loop.html" class="sidebar-link">EventLoop</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/middleware/netty/nio/selectors/selector" class="sidebar-heading clickable"><span>Selectors</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/middleware/netty/nio/selectors/open-selector.html" class="sidebar-link">OpenSelector</a></li><li><a href="/middleware/netty/nio/selectors/thread-factory.html" class="sidebar-link">DefaultThreadFactory</a></li><li><a href="/middleware/netty/nio/selectors/chooser-factory.html" class="sidebar-link">ChooserFactory</a></li></ul></section></li><li><a href="/middleware/netty/nio/bootstrap/bootstrap.html" class="sidebar-link">Bootstrap</a></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/middleware/netty/nio/channels/channel" class="sidebar-heading clickable"><span>Channel</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/middleware/netty/nio/channels/channel-init.html" class="sidebar-link">Channel-Init</a></li><li><a href="/middleware/netty/nio/channels/channel-register.html" class="sidebar-link">Channel-register</a></li><li><a href="/middleware/netty/nio/channels/channel-handler.html" class="sidebar-link">Channel-handler</a></li><li><a href="/middleware/netty/nio/channels/channel-bind.html" class="sidebar-link">Channel-bind</a></li><li><a href="/middleware/netty/nio/channels/channel-unsafe.html" class="sidebar-link">Channel-Unsafe</a></li><li><a href="/middleware/netty/nio/channels/channel-pipeline.html" class="sidebar-link">Channel-Pipeline</a></li></ul></section></li><li><a href="/middleware/netty/nio/codec/codec.html" class="sidebar-link">Codec</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>编程语言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading open"><span>虚拟机</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-3"><a href="/languages/java/jvm/layout/run-time-data-areas" class="sidebar-heading clickable"><span>内存布局</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/languages/java/jvm/layout/pc-register.html" class="sidebar-link">Pc Register</a></li><li><a href="/languages/java/jvm/layout/stacks.html" class="sidebar-link">Stacks</a></li><li><a href="/languages/java/jvm/layout/Frames.html" class="sidebar-link">Frames</a></li><li><a href="/languages/java/jvm/layout/share-data.html" class="sidebar-link">共享数据</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-3"><p class="sidebar-heading open"><span>垃圾回收器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/languages/java/jvm/jvm-select.html" class="sidebar-link">jvm-select</a></li><li><a href="/languages/java/jvm/SerialHeap.html" class="sidebar-link">SerialHeap</a></li><li><a href="/languages/java/jvm/safepoint.html" aria-current="page" class="active sidebar-link">safepoint</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/languages/java/jvm/safepoint.html#vmthread" class="sidebar-link">vmThread</a></li><li class="sidebar-sub-header"><a href="/languages/java/jvm/safepoint.html#safepointsynchronize" class="sidebar-link">SafepointSynchronize</a></li><li class="sidebar-sub-header"><a href="/languages/java/jvm/safepoint.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/languages/java/jvm/jvm-select-use.html" class="sidebar-link">生产使用</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/languages/java/thread/java/juc/read-me" class="sidebar-heading clickable"><span>多线程编程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-3"><p class="sidebar-heading open"><span>基础知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/languages/java/thread/java/juc/aos.html" class="sidebar-link">exclusively</a></li><li><a href="/languages/java/thread/java/juc/atomic.html" class="sidebar-link">cas</a></li><li><a href="/languages/java/thread/java/juc/aqs.html" class="sidebar-link">aqs</a></li><li><a href="/languages/java/thread/java/juc/blocking.html" class="sidebar-link">LockSupport</a></li><li><a href="/languages/java/thread/java/juc/clh.html" class="sidebar-link">clh锁</a></li><li><a href="/languages/java/thread/java/juc/condition.html" class="sidebar-link">Condition</a></li><li><a href="/languages/java/thread/java/juc/future.html" class="sidebar-link">FutureTask</a></li><li><a href="/languages/java/thread/java/juc/daemon.html" class="sidebar-link">daemon</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-3"><p class="sidebar-heading"><span>应用</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/languages/java/thread/java/juc/thread-factory.html" class="sidebar-link">ThreadFactory</a></li><li><a href="/languages/java/thread/java/juc/rejected-execution-handler.html" class="sidebar-link">ExecutionPolicy</a></li><li><a href="/languages/java/thread/java/juc/work.html" class="sidebar-link">Worker</a></li><li><a href="/languages/java/thread/java/juc/thread-pool-executor.html" class="sidebar-link">ThreadPoolExecutor</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/languages/java/auto-box.html" class="sidebar-link">自动装箱</a></li><li><a href="/languages/java/delay-queue.html" class="sidebar-link">锁局部变量</a></li><li><a href="/languages/java/introduction-to-java-bytecode.html" class="sidebar-link">基于栈的指令集</a></li><li><a href="/languages/java/heap-java.html" class="sidebar-link">Heap源码</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>go</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/languages/go/heap-go.html" class="sidebar-link">Heap源码</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基本功</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/basic-skill/algorithms" class="sidebar-heading clickable open"><span>算法</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><a href="/basic-skill/algorithms/sort/sort" class="sidebar-heading clickable open"><span>排序</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic-skill/algorithms/sort/bubble-sort.html" class="sidebar-link">冒泡排序</a></li><li><a href="/basic-skill/algorithms/sort/select-sort.html" class="sidebar-link">选择排序</a></li><li><a href="/basic-skill/algorithms/sort/insert-sort.html" class="sidebar-link">插入排序</a></li><li><a href="/basic-skill/algorithms/sort/merge-sort.html" class="sidebar-link">归并排序</a></li><li><a href="/basic-skill/algorithms/sort/quick-sort.html" class="sidebar-link">快速排序</a></li><li><a href="/basic-skill/algorithms/other/Edsger-Dijkstra.html" class="sidebar-link">荷兰国旗</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>数据结构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic-skill/algorithms/structure/union-find-structure.html" class="sidebar-link">并查集</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/basic-skill/algorithms/tree/binary-tree-concept" class="sidebar-heading clickable"><span>Tree</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic-skill/algorithms/tree/pre-order.html" class="sidebar-link">前序遍历</a></li><li><a href="/basic-skill/algorithms/tree/binary-tree-algs4.html" class="sidebar-link">二叉树-算法4</a></li><li><a href="/basic-skill/algorithms/tree/balanced-search-trees.html" class="sidebar-link">2-3-搜索树</a></li><li><a href="/basic-skill/algorithms/heap/heap.html" class="sidebar-link">Heap</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/basic-skill/algorithms/graphs/" class="sidebar-heading clickable"><span>图</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic-skill/algorithms/graphs/graph-concept.html" class="sidebar-link">概念</a></li><li><a href="/basic-skill/algorithms/graphs/directed-graph.html" class="sidebar-link">有向图</a></li><li><a href="/basic-skill/algorithms/graphs/graph-search.html" class="sidebar-link">搜索</a></li><li><a href="/basic-skill/algorithms/graphs/minimum-spanning-tree.html" class="sidebar-link">最小生成树</a></li><li><a href="/basic-skill/algorithms/graphs/shortest-path-algnorithms.html" class="sidebar-link">最短路径算法</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic-skill/algorithms/other/binary-Search.html" class="sidebar-link">二分查找法</a></li><li><a href="/basic-skill/algorithms/other/Top-down.html" class="sidebar-link">自顶而下</a></li><li><a href="/basic-skill/algorithms/other/swap-or-exchange.html" class="sidebar-link">交换还是移动？</a></li><li><a href="/basic-skill/algorithms/other/xor.html" class="sidebar-link">Xor</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/basic-skill/design-pattern/" class="sidebar-heading clickable"><span>设计模式</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading open"><span>policy</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic-skill/design-pattern/policy/spring-error-demo.html" class="sidebar-link">spring-error-demo</a></li><li><a href="/basic-skill/design-pattern/policy/spring-policy.html" class="sidebar-link">spring-policy</a></li><li><a href="/basic-skill/design-pattern/policy/spring-fly-weight.html" class="sidebar-link">spring-flyweight-policy</a></li></ul></section></li><li><a href="/basic-skill/design-pattern/interpreter/interpreter-pattern.html" class="sidebar-link">interpreter</a></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/basic-skill/design-pattern/structure/decorator/concept" class="sidebar-heading clickable"><span>decorator</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic-skill/design-pattern/structure/decorator/decorator-java.html" class="sidebar-link">Decorator-Java</a></li><li><a href="/basic-skill/design-pattern/structure/decorator/decorator-netty.html" class="sidebar-link">Decorator-Netty</a></li><li><a href="/basic-skill/design-pattern/structure/decorator/decorator-hystrix.html" class="sidebar-link">Decorator-Hystrix</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/framework/" class="sidebar-heading clickable"><span>框架</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><a href="/framework/spring/" class="sidebar-heading clickable open"><span>Spring</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/framework/spring/di-concept.html" class="sidebar-link">DI概念</a></li><li><a href="/framework/spring/di.html" class="sidebar-link">DI实现</a></li><li><a href="/framework/spring/initialize-bean.html" class="sidebar-link">扩展点</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>计算机网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basic-skill/network/tree-shake-hands.html" class="sidebar-link">三次握手</a></li><li><a href="/basic-skill/network/four-wave.html" class="sidebar-link">四次挥手</a></li></ul></section></li></ul></section></li><li><a href="/linked/" class="sidebar-link">常用网站</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="safepoint">safepoint</h1> <h2 id="vmthread">vmThread</h2> <p><code>vmThread run()</code>会一直<code>loop</code>任务处理任务，也就是处理<code>Command</code>，<code>inner_execute(_next_vm_operation);</code>支持的命令在<code>vmOperation.hpp</code>会有所体现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Breakpoint</span> reached<span class="token operator">:</span> vmThread<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">429</span>
<span class="token class-name">Stack</span><span class="token operator">:</span> 
  <span class="token class-name">VMThread</span><span class="token operator">::</span><span class="token function">inner_execute</span><span class="token punctuation">(</span><span class="token class-name">VM_Operation</span><span class="token operator">*</span><span class="token punctuation">)</span> vmThread<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">429</span>
  <span class="token class-name">VMThread</span><span class="token operator">::</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> vmThread<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">496</span>
  <span class="token class-name">VMThread</span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> vmThread<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">175</span>
  <span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">call_run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> thread<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">358</span>
  <span class="token function">thread_native_entry</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">*</span><span class="token punctuation">)</span> os_bsd<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">575</span>
  _pthread_start <span class="token number">0x00007ff81a3234f4</span>
  thread_start <span class="token number">0x00007ff81a31f00f</span>
</code></pre></div><p><code>vmOperation.hpp</code>部分展示</p> <div class="language-java extra-class"><pre class="language-java"><code>#define <span class="token function">VM_OPS_DO</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>                       \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span>                                  \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">Cleanup</span><span class="token punctuation">)</span>                               \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">ThreadDump</span><span class="token punctuation">)</span>                            \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">PrintThreads</span><span class="token punctuation">)</span>                          \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">FindDeadlocks</span><span class="token punctuation">)</span>                         \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">ClearICs</span><span class="token punctuation">)</span>                              \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">ForceSafepoint</span><span class="token punctuation">)</span>                        \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">ForceAsyncSafepoint</span><span class="token punctuation">)</span>                   \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">DeoptimizeFrame</span><span class="token punctuation">)</span>                       \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">DeoptimizeAll</span><span class="token punctuation">)</span>                         \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">ZombieAll</span><span class="token punctuation">)</span>                             \
  <span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">Verify</span><span class="token punctuation">)</span>                                \
<span class="token comment">// 其他忽略，请自行查看</span>
</code></pre></div><p>线程在一直<code>loop</code>时会进行安全点初始化，然后进行自旋转，然后处理<code>command</code>，并且在<code>commad</code>前后设置了安全点开始和关闭，其逻辑是否执行是根据命令是否需要进行的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">VMThread</span><span class="token operator">::</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果命令为空异常</span>
  <span class="token class-name">SafepointSynchronize</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>_vm_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置当前线程到一些操作上</span>
  cleanup_op<span class="token punctuation">.</span><span class="token function">set_calling_thread</span><span class="token punctuation">(</span>_vm_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  safepointALot_op<span class="token punctuation">.</span><span class="token function">set_calling_thread</span><span class="token punctuation">(</span>_vm_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果需要被中断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">should_terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待操作</span>
    <span class="token function">wait_for_operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">should_terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_next_vm_operation <span class="token operator">!=</span> NULL<span class="token punctuation">,</span> <span class="token string">&quot;Must have one&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inner_execute</span><span class="token punctuation">(</span>_next_vm_operation<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">SafepointSynchronize</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">*</span> vmthread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 等待barrier</span>
  _wait_barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaitBarrier</span><span class="token punctuation">(</span>vmthread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">SafepointTracing</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 设置轨迹开始时间</span>
<span class="token keyword">void</span> <span class="token class-name">SafepointTracing</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _last_safepoint_end_time_ns <span class="token operator">=</span> os<span class="token operator">::</span><span class="token function">javaTimeNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">VMThread</span><span class="token operator">::</span><span class="token function">wait_for_operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建一个锁这里就是 MonitorLocker ml_op_lock = new MonitorLocker(...)</span>
  <span class="token class-name">MonitorLocker</span> <span class="token function">ml_op_lock</span><span class="token punctuation">(</span><span class="token class-name">VMOperation_lock</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token operator">::</span><span class="token function">_no_safepoint_check_flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 清除之前状态</span>
  <span class="token comment">// 在第一次调用时，这会清除一个虚拟占位符，我也不太明白这句话是什么意思</span>
  _next_vm_operation <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
  <span class="token comment">// 通知操作完成，并且唤醒下一个操作可以执行</span>
  ml_op_lock<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 还是判断状态，如果线程没被中断，一直循环</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">should_terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 必要时销毁线程</span>
    <span class="token function">self_destruct_if_needed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 下一个指令为空跳出自旋</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_next_vm_operation <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">handshake_alot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">{</span>
        <span class="token class-name">MutexUnlocker</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token class-name">VMOperation_lock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandshakeALotClosure</span> hal_cl<span class="token punctuation">;</span>
        <span class="token class-name">Handshake</span><span class="token operator">::</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hal_cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_next_vm_operation <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在这里会设置周期</span>
    <span class="token function">setup_periodic_safepoint_if_needed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_next_vm_operation <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 没发现任何任务需要执行，唤醒后面节点</span>
    ml_op_lock<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待保证安全点间隔</span>
    ml_op_lock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token class-name">GuaranteedSafepointInterval</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">self_destruct_if_needed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 销毁的条件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SelfDestructTimer</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">VMError</span><span class="token operator">::</span><span class="token function">is_error_reported</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>os<span class="token operator">::</span><span class="token function">elapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token class-name">SelfDestructTimer</span> <span class="token operator">*</span> <span class="token number">60.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tty<span class="token operator">-&gt;</span><span class="token function">print_cr</span><span class="token punctuation">(</span><span class="token string">&quot;VM self-destructed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="safepointsynchronize">SafepointSynchronize</h2> <h3 id="inner-execute">inner_execute</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">VMThread</span><span class="token operator">::</span><span class="token function">inner_execute</span><span class="token punctuation">(</span><span class="token class-name">VM_Operation</span><span class="token operator">*</span> op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_VM_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Must be the VM thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">VM_Operation</span><span class="token operator">*</span> prev_vm_operation <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_vm_operation <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_cur_vm_operation<span class="token operator">-&gt;</span><span class="token function">allow_nested_vm_operations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected nested VM operation %s requested by operation %s&quot;</span><span class="token punctuation">,</span>
            op<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _cur_vm_operation<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    op<span class="token operator">-&gt;</span><span class="token function">set_calling_thread</span><span class="token punctuation">(</span>_cur_vm_operation<span class="token operator">-&gt;</span><span class="token function">calling_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prev_vm_operation <span class="token operator">=</span> _cur_vm_operation<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _cur_vm_operation <span class="token operator">=</span> op<span class="token punctuation">;</span>

  <span class="token class-name">HandleMark</span> <span class="token function">hm</span><span class="token punctuation">(</span><span class="token class-name">VMThread</span><span class="token operator">::</span><span class="token function">vm_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">EventMarkVMOperation</span> <span class="token function">em</span><span class="token punctuation">(</span><span class="token string">&quot;Executing %sVM operation: %s&quot;</span><span class="token punctuation">,</span> prev_vm_operation <span class="token operator">!=</span> NULL <span class="token operator">?</span> <span class="token string">&quot;nested &quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> op<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">log_debug</span><span class="token punctuation">(</span>vmthread<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Evaluating %s %s VM operation: %s&quot;</span><span class="token punctuation">,</span>
                       prev_vm_operation <span class="token operator">!=</span> NULL <span class="token operator">?</span> <span class="token string">&quot;nested&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                      _cur_vm_operation<span class="token operator">-&gt;</span><span class="token function">evaluate_at_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;safepoint&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;non-safepoint&quot;</span><span class="token punctuation">,</span>
                      _cur_vm_operation<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 上面是一系列的基础校验</span>
  bool end_safepoint <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  bool has_timeout_task <span class="token operator">=</span> <span class="token punctuation">(</span>_timeout_task <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在这路使用了一个环绕，类似切面，根据command指令类型判断是否需要开启该切面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_vm_operation<span class="token operator">-&gt;</span><span class="token function">evaluate_at_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token class-name">SafepointSynchronize</span><span class="token operator">::</span><span class="token function">is_at_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SafepointSynchronize</span><span class="token operator">::</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>has_timeout_task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _timeout_task<span class="token operator">-&gt;</span><span class="token function">arm</span><span class="token punctuation">(</span>_cur_vm_operation<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    end_safepoint <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">evaluate_operation</span><span class="token punctuation">(</span>_cur_vm_operation<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 安全点关闭</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>end_safepoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>has_timeout_task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _timeout_task<span class="token operator">-&gt;</span><span class="token function">disarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">SafepointSynchronize</span><span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _cur_vm_operation <span class="token operator">=</span> prev_vm_operation<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="begin">begin</h3> <p>将所有线程向前滚动到安全点。必须由<code>VMThread</code>调用。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">SafepointSynchronize</span><span class="token operator">::</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 必须由 VMThread 调用。</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_VM_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Only VM thread may execute a safepoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">EventSafepointBegin</span> begin_event<span class="token punctuation">;</span>
  <span class="token comment">// 根据类型进行归集追踪</span>
  <span class="token class-name">SafepointTracing</span><span class="token operator">::</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token class-name">VMThread</span><span class="token operator">::</span><span class="token function">vm_op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 安全点开始</span>
  <span class="token class-name">Universe</span><span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">safepoint_synchronize_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 通过获取 Threads_lock，我们确保没有线程将要启动或退出。它在 SafepointSynchronize::end() 中再次释放。</span>
  <span class="token class-name">Threads_lock</span><span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取所有线程数量</span>
  <span class="token keyword">int</span> nof_threads <span class="token operator">=</span> <span class="token class-name">Threads</span><span class="token operator">::</span><span class="token function">number_of_threads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  _nof_threads_hit_polling_page <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 重置活动 JNI 关键线程的计数</span>
  _current_jni_active_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置要等待的线程数</span>
  _waiting_to_block <span class="token operator">=</span> nof_threads<span class="token punctuation">;</span>

  jlong safepoint_limit_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SafepointTimeout</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置限制时间，以便进行比较，看看这是否花费了太长时间才能完成。</span>
    safepoint_limit_time <span class="token operator">=</span> <span class="token class-name">SafepointTracing</span><span class="token operator">::</span><span class="token function">start_of_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>jlong<span class="token punctuation">)</span><span class="token class-name">SafepointTimeoutDelay</span> <span class="token operator">*</span> <span class="token punctuation">(</span>NANOUNITS <span class="token operator">/</span> MILLIUNITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeout_error_printed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">EventSafepointStateSynchronization</span> sync_event<span class="token punctuation">;</span>
  <span class="token keyword">int</span> initial_running <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">arm_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将旋转直到所有线程都安全。</span>
  <span class="token keyword">int</span> iterations <span class="token operator">=</span> <span class="token function">synchronize_threads</span><span class="token punctuation">(</span>safepoint_limit_time<span class="token punctuation">,</span> nof_threads<span class="token punctuation">,</span> <span class="token operator">&amp;</span>initial_running<span class="token punctuation">)</span><span class="token punctuation">;</span>

#ifndef <span class="token class-name">PRODUCT</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">VerifyCrossModifyFence</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">JavaThreadIteratorWithHandle</span> jtiwh<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token class-name">JavaThread</span> <span class="token operator">*</span>cur <span class="token operator">=</span> jtiwh<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cur<span class="token operator">-&gt;</span><span class="token function">set_requires_cross_modify_fence</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
#endif
  <span class="token comment">// 记录状态</span>
  _state <span class="token operator">=</span> _synchronized<span class="token punctuation">;</span>
  <span class="token class-name">OrderAccess</span><span class="token operator">::</span><span class="token function">fence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">++</span>_safepoint_id<span class="token punctuation">;</span>

#ifdef <span class="token class-name">ASSERT</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JavaThreadIteratorWithHandle</span> jtiwh<span class="token punctuation">;</span> <span class="token class-name">JavaThread</span> <span class="token operator">*</span>cur <span class="token operator">=</span> jtiwh<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span><span class="token function">was_visited_for_critical_count</span><span class="token punctuation">(</span>_safepoint_counter<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;missed a thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif <span class="token comment">// ASSERT</span>
  <span class="token class-name">GCLocker</span><span class="token operator">::</span><span class="token function">set_jni_lock_count</span><span class="token punctuation">(</span>_current_jni_active_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">post_safepoint_synchronize_event</span><span class="token punctuation">(</span>sync_event<span class="token punctuation">,</span>
                                   _safepoint_id<span class="token punctuation">,</span>
                                   initial_running<span class="token punctuation">,</span>
                                   _waiting_to_block<span class="token punctuation">,</span> iterations<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">SafepointTracing</span><span class="token operator">::</span><span class="token keyword">synchronized</span><span class="token punctuation">(</span>nof_threads<span class="token punctuation">,</span> initial_running<span class="token punctuation">,</span> _nof_threads_hit_polling_page<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">EventSafepointCleanup</span> cleanup_event<span class="token punctuation">;</span>
  <span class="token function">do_cleanup_tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">post_safepoint_cleanup_event</span><span class="token punctuation">(</span>cleanup_event<span class="token punctuation">,</span> _safepoint_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">post_safepoint_begin_event</span><span class="token punctuation">(</span>begin_event<span class="token punctuation">,</span> _safepoint_id<span class="token punctuation">,</span> nof_threads<span class="token punctuation">,</span> _current_jni_active_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">SafepointTracing</span><span class="token operator">::</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>主动式中断的思想是当垃圾收集需要中断线程的时候，不直接对线程操作，仅仅简单地设置一个标志位，对应的代码为<code>arm_safepoint()</code></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> SafepointSynchronize<span class="token operator">::</span><span class="token function">arm_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 开始将系统带到安全点的过程。 Java 线程可以处于几种不同的状态，并被不同的机制停止：</span>
  <span class="token comment">//  1. 运行中断 当执行分支返回字节码解释器检查轮询是否被中断，如果是在 SS::block() 中的块。</span>
  <span class="token comment">//  2. 在本机代码中运行当从本机代码返回时，Java线程必须检查安全点_state以查看是否必须阻塞。如果 VM 线程在本机中看到 Java 线程，它不会等待该线程阻塞。安全点状态和 Java 线程状态的内存写入和读取顺序至关重要。为了保证内存写入相对于彼此串行化，VM线程发出内存屏障指令</span>
  <span class="token comment">//  3. 运行编译的代码  如果我们试图到达安全点，编译后的代码会读取设置为错误的本地轮询页面。</span>
  <span class="token comment">//  4. 阻塞 在安全点操作完成之前，被阻塞的线程将不允许从阻塞状态返回。</span>
  <span class="token comment">//  5. 如果 Java 线程当前正在 VM 中运行或在状态之间转换，则安全点代码将轮询线程状态，直到线程在尝试转换到新状态或锁定安全点检查监视器时自行阻塞。</span>
 
  <span class="token comment">// 设置屏障信号</span>
  _wait_barrier<span class="token operator">-&gt;</span><span class="token function">arm</span><span class="token punctuation">(</span>static_cast<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>_safepoint_counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Atomic<span class="token operator">::</span><span class="token function">release_store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_safepoint_counter<span class="token punctuation">,</span> _safepoint_counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  OrderAccess<span class="token operator">::</span><span class="token function">storestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Ordered with _safepoint_counter</span>
  _state <span class="token operator">=</span> _synchronizing<span class="token punctuation">;</span>

  OrderAccess<span class="token operator">::</span><span class="token function">storestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// storestore, global state -&gt; local state</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>JavaThreadIteratorWithHandle jtiwh<span class="token punctuation">;</span> JavaThread <span class="token operator">*</span>cur <span class="token operator">=</span> jtiwh<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Make sure the threads start polling, it is time to yield.</span>
    SafepointMechanism<span class="token operator">::</span><span class="token function">arm_local_poll</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  OrderAccess<span class="token operator">::</span><span class="token function">fence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// storestore|storeload, global state -&gt; local state</span>
<span class="token punctuation">}</span>
</code></pre></div><p>等待所有线程都在安全点，代码可以查看<code>synchronize_threads(safepoint_limit_time, nof_threads, &amp;initial_running)</code></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> SafepointSynchronize<span class="token operator">::</span><span class="token function">synchronize_threads</span><span class="token punctuation">(</span>jlong safepoint_limit_time<span class="token punctuation">,</span> <span class="token keyword">int</span> nof_threads<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> initial_running<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  JavaThreadIteratorWithHandle jtiwh<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> JavaThread <span class="token operator">*</span>cur <span class="token operator">=</span> jtiwh<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span><span class="token function">safepoint_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Illegal initial state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  jtiwh<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// ASSERT</span></span>
  <span class="token comment">// 如果没有线程仍在运行，我们已经完成了。</span>
  <span class="token keyword">int</span> still_running <span class="token operator">=</span> nof_threads<span class="token punctuation">;</span>
  ThreadSafepointState <span class="token operator">*</span>tss_head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  ThreadSafepointState <span class="token operator">*</span><span class="token operator">*</span>p_prev <span class="token operator">=</span> <span class="token operator">&amp;</span>tss_head<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> JavaThread <span class="token operator">*</span>cur <span class="token operator">=</span> jtiwh<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ThreadSafepointState <span class="token operator">*</span>cur_tss <span class="token operator">=</span> cur<span class="token operator">-&gt;</span><span class="token function">safepoint_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>cur_tss<span class="token operator">-&gt;</span><span class="token function">get_next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;Must be NULL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">thread_not_running</span><span class="token punctuation">(</span>cur_tss<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">--</span>still_running<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>p_prev <span class="token operator">=</span> cur_tss<span class="token punctuation">;</span>
      p_prev <span class="token operator">=</span> cur_tss<span class="token operator">-&gt;</span><span class="token function">next_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>p_prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token function">DEBUG_ONLY</span><span class="token punctuation">(</span><span class="token function">assert_list_is_valid</span><span class="token punctuation">(</span>tss_head<span class="token punctuation">,</span> still_running<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
  <span class="token operator">*</span>initial_running <span class="token operator">=</span> still_running<span class="token punctuation">;</span>
  <span class="token comment">// 如果没有线程仍在运行，我们已经完成了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>still_running <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>tss_head <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;Must be empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 迭代了多少次</span>
  <span class="token keyword">int</span> iterations <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// The first iteration is above.</span>
  <span class="token class-name">int64_t</span> start_time <span class="token operator">=</span> os<span class="token operator">::</span><span class="token function">javaTimeNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>SafepointTimeout <span class="token operator">&amp;&amp;</span> safepoint_limit_time <span class="token operator">&lt;</span> os<span class="token operator">::</span><span class="token function">javaTimeNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print_safepoint_timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    p_prev <span class="token operator">=</span> <span class="token operator">&amp;</span>tss_head<span class="token punctuation">;</span>
    ThreadSafepointState <span class="token operator">*</span>cur_tss <span class="token operator">=</span> tss_head<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cur_tss <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>cur_tss<span class="token operator">-&gt;</span><span class="token function">is_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Illegal initial state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">thread_not_running</span><span class="token punctuation">(</span>cur_tss<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">--</span>still_running<span class="token punctuation">;</span>
        <span class="token operator">*</span>p_prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        ThreadSafepointState <span class="token operator">*</span>tmp <span class="token operator">=</span> cur_tss<span class="token punctuation">;</span>
        cur_tss <span class="token operator">=</span> cur_tss<span class="token operator">-&gt;</span><span class="token function">get_next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp<span class="token operator">-&gt;</span><span class="token function">set_next</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_prev <span class="token operator">=</span> cur_tss<span class="token punctuation">;</span>
        p_prev <span class="token operator">=</span> cur_tss<span class="token operator">-&gt;</span><span class="token function">next_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cur_tss <span class="token operator">=</span> cur_tss<span class="token operator">-&gt;</span><span class="token function">get_next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">DEBUG_ONLY</span><span class="token punctuation">(</span><span class="token function">assert_list_is_valid</span><span class="token punctuation">(</span>tss_head<span class="token punctuation">,</span> still_running<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>still_running <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">back_off</span><span class="token punctuation">(</span>start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    iterations<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果运行线程大于0，一直loop</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>still_running <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>tss_head <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;Must be empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> iterations<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="end">end</h3> <p>重新启动所有挂起的线程</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">void</span> SafepointSynchronize<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 必须由 VMThread 调用。</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>Threads_lock<span class="token operator">-&gt;</span><span class="token function">owned_by_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;must hold Threads_lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  EventSafepointEnd event<span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>Thread<span class="token operator">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_VM_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Only VM thread can execute a safepoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">disarm_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Universe<span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">safepoint_synchronize_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  SafepointTracing<span class="token operator">::</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 发送安全点结束事件</span>
  <span class="token function">post_safepoint_end_event</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token function">safepoint_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> SafepointSynchronize<span class="token operator">::</span><span class="token function">disarm_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint64_t</span> active_safepoint_counter <span class="token operator">=</span> _safepoint_counter<span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    JavaThreadIteratorWithHandle jtiwh<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> JavaThread <span class="token operator">*</span>cur <span class="token operator">=</span> jtiwh<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span><span class="token function">has_pending_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                cur<span class="token operator">-&gt;</span><span class="token function">safepoint_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_at_poll_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token string">&quot;safepoint installed a pending exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// ASSERT</span></span>
    OrderAccess<span class="token operator">::</span><span class="token function">fence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// keep read and write of _state from floating up</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>_state <span class="token operator">==</span> _synchronized<span class="token punctuation">,</span> <span class="token string">&quot;must be synchronized before ending safepoint synchronization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Change state first to _not_synchronized.</span>
    <span class="token comment">// No threads should see _synchronized when running.</span>
    _state <span class="token operator">=</span> _not_synchronized<span class="token punctuation">;</span>

    <span class="token comment">// Set the next dormant (even) safepoint id.</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_safepoint_counter <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;must be odd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Atomic<span class="token operator">::</span><span class="token function">release_store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_safepoint_counter<span class="token punctuation">,</span> _safepoint_counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    OrderAccess<span class="token operator">::</span><span class="token function">fence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Keep the local state from floating up.</span>

    jtiwh<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> JavaThread <span class="token operator">*</span>current <span class="token operator">=</span> jtiwh<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Clear the visited flag to ensure that the critical counts are collected properly.</span>
      <span class="token function">DEBUG_ONLY</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span><span class="token function">reset_visited_for_critical_count</span><span class="token punctuation">(</span>active_safepoint_counter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
      ThreadSafepointState<span class="token operator">*</span> cur_state <span class="token operator">=</span> current<span class="token operator">-&gt;</span><span class="token function">safepoint_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>cur_state<span class="token operator">-&gt;</span><span class="token function">is_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread not suspended at safepoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cur_state<span class="token operator">-&gt;</span><span class="token function">restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TSS _running</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>cur_state<span class="token operator">-&gt;</span><span class="token function">is_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;safepoint state has not been reset&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token comment">// ~JavaThreadIteratorWithHandle</span>

  <span class="token comment">// 释放线程锁，这样线程就可以被再次创建销毁</span>
  Threads_lock<span class="token operator">-&gt;</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 在安全点的线程被唤醒</span>
  _wait_barrier<span class="token operator">-&gt;</span><span class="token function">disarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结">总结</h2> <p>安全点开启使用了锁机制，开启后设置标记位，等待线程进入安全点。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/languages/java/jvm/SerialHeap.html" class="prev">
        SerialHeap
      </a></span> <span class="next"><a href="/languages/java/jvm/jvm-select-use.html">
        生产使用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/assets/js/app.6347abd9.js" defer></script><script src="/assets/js/2.b0206109.js" defer></script><script src="/assets/js/93.a953f7ea.js" defer></script>
  </body>
</html>
